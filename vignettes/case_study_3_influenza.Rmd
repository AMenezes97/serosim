---
title: "Case study 3: A multi-strain pathogen system with cross-reactive antibody dynamics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{case_study_3_influenza}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: cs3_influenza_citations.bib
---

```{r, echo=FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)
```
# 1.0 Outline
This vignette demonstrates how _serosim_ can simulate complex antibody profiles arising from repeated exposure to antigenically related strains of the same pathogen, based on A/H3N2 influenza. 
Each exposure stimulates a combination of _de novo_ and memory antibody responses, resulting in the presence of antibodies effective against all strains. The effectiveness of these antibodies against a particular strain depends on the set and timing of strains the individual has been exposed to [@Smith2004, @Kucharski2018, @Krammer2019]. 
The simulation will track natural infection dynamics and antibody profiles to these multiple strains for 100 individuals across a 50 year period, demonstrating how complex antibody profiles, or antibody landscapes, build over the life course [@Fonville2014, @Lessler2012]. 
We will simulate a longitudinal serological survey with two discretized measurements (based on the haemagglutination inhibition assay) of each individual's biomarker levels against each strains based on existing serosurvey data [@Yang2020]. 

Outline:

1. We will first set up each of the required arguments and models for _runserosim_ in 
the order outlined in the methods section of the paper. In this example, the terms biomarker quantity, 
titer level and antibody level are interchangeable. 
2. We will use well characterized epidemiological and immunological characteristics 
of influenza when selecting our models wherever possible and make reasonable 
assumptions for other required models wherever information is lacking. For this example, 
we will use arbitrarily selected antibody kinetics parameters. Users can perform a 
literature review to select the best parameters for their strains of interest.
3. Within each section below, we will briefly explain the rationale behind our selected 
model inputs. We caution users to conduct their own research into the models and 
associated parameters which best align with their disease system and biomarker test kits. 

Load necessary packages:
```{r message=FALSE, warning=FALSE,eval=TRUE}
## Install and load serosim 
## devtools::install_github("AMenezes97/serosim")
library(serosim)

## Load additional packages required 
library(tidyverse)
library(data.table)
library(ggplot2)
library(patchwork)
library(reshape2)
```


# 1.1 Simulation settings and population demography
We will simulate a 50 year period of influenza circulation, roughly representing the introduction of A/H3N2 into humans in 1968. The simulation will use monthly time steps to balance computational time but with sufficient resolution to represent transient antibody kinetics.

For this simulation, the only demography variable we will track is age -- individuals cannot be exposed to influenza strains which circulated before they were born.

```{r}
## Specify the number of time periods to simulate 
times <- seq(1,4.5*10*12,by=1) 
simulation_settings <- list("t_start"=1,"t_end"=max(times))

## Generate the population demography tibble
N<-100
## See help file(?generate_pop_demography) for more information on function arguments.
## age_min is set to 0 which allows births to occur until the last time step
## Let's assume that no individuals are removed from the population and set prob_removal to 0
demography <- generate_pop_demography(N, times, age_min=0, prob_removal=0)

n_strains <- 10
possible_strains <- 1:n_strains
```

# 1.2 A/H3N2 influenza epidemiology
A/H3N2 influenza has distinctive epidemiology, whereby one group of antigenically similar viruses (termed a cluster) circulates for 3-5 years before being replaced by a new, antigenically distinct cluster [@Smith2004]. The phylogeny of A/H3N2 viruses is often referred to as ladder-like to capture the fact that influenza demonstrates limited genetic diversity at a single point in time, but substantial diversity in the long-term. We will capture this in our simulation by assuming that 10 antigenically distinct strains each circulate for 5 years before being replaced by the next strain.

# 1.3 Exposure to biomarker mapping
One of the key features of influenza serology is that different strains of the same subtype are antigenically related by virtue of having a mixture of conserved and distinct epitopes on surface proteins. Strain replacements are the result of mutations at key epitopes allowing immune escape. Thus, an individual's immune profile is the culmination of antibodies targeting combinations of epitopes consistent with the set of strains they have been exposed to.

There are two ways we could model these dynamics with _serosim_. First, we could map each strain to a set of epitopes, such that sets of epitopes partially overlap between strains. The exposure ID variable corresponds to each strain, and the biomarker ID corresponds to antibodies binding to each specific epitope. Data at this resolution are rare, particularly for serosurveillance, requiring a complex assays such as VirScan which detects antibody binding to short peptide sequences. The data demands and computational complexity prohibit a realistic simulation model. 

The second approach is to consider each biomarker ID as the output of a common assay, such as a microneutralization assay or haemagglutination inhibition assay. These assays measure the overall binding or reactivity of antibodies in a serum sample against whole proteins or virions, and thus represent the aggregate effect of all epitope-level binding. A high measurement on this sort of assay reflects the joint effect of high antibody levels against epitopes presented in the assay; a lower measurement reflects lower antibody concentrations and/or recognition of fewer epitopes. Strains are considered to cross-react when antibodies elicited following exposure to one strain are produce a measurable effect against another strain, reflecting the sharing of epitopes between the two strains.

For the _serosim_ biomarker map, we simply model this as an all-to-all mapping between each strain and individual could be exposed to (exposure ID) and each strain that could be included in the assay (biomarker ID).


```{r}
## Create cross-reactivity matrix
x_coord <- numeric(n_strains)
y_coord <- numeric(n_strains)

## Set antigenic evolution as random walk in two dimensions
x_coord[1] <- 0
y_coord[1] <- 0
for(i in 2:length(possible_strains)){
  x_coord[i] <- x_coord[i-1] + rlnorm(1, mean=log(1), sd=0.5)
  y_coord[i] <- y_coord[i-1] + rlnorm(1, mean=log(1), sd=0.5)
}
antigenic_map <- data.frame(x_coord=x_coord, y_coord=y_coord)
antigenic_map <- as.matrix(dist(antigenic_map, diag=TRUE, upper=TRUE))
antigenic_map <- exp(-0.25*antigenic_map)
antigenic_map <- antigenic_map %>% as_tibble() %>% mutate(exposure_id=1:n()) %>% pivot_longer(-exposure_id) %>% rename(biomarker_id=name) %>% mutate(biomarker_id = as.numeric(biomarker_id))
```



# 1.4 Force of Exposure and Exposure Model
Now, we need to specify the foe_pars argument which contains the force of 
exposure for all exposure_ids across all time steps. We also specify the 
exposure model which will be called within _runserosim_ later. The exposure model 
will determine the probability that an individual is exposed to a specific 
exposure event. 

Since we did not specify different groups within demography, all individuals will 
automatically be assigned group 1. Therefore, we only need 1 row for dimension
1 in foe_pars. Groups can be used as an indicator of location if the user wishes to 
specify a location specific force of exposure (See case study 2). 
Dimension 3 of the foe_array must be in the same order as the exposure_id within 
the biomarker map. For example, the force of exposure for exposure_id 1 will be 
inputted within the foe_pars[,,1]. 

Here, we specified the same force of exposure for circulating strains within foe_pars for 
simplicity but users will likely have varying numbers to match real world settings. 
Each strain is only circulating for 40 time steps with no co-circulation.
```{r}
## Seasonal forcing
beta <- 0.2
sigma <- 1
seasonality <- beta*(1 + sigma*cos(2*pi*(times-1)/12))

## If we assume an infectious period of 5 days, the simulation gives an annually oscillating R0 between 0 and 2 
plot(seasonality*5,type='l')

## Create an empty array to store the force of exposure for all exposure types
foe_pars <- array(0, dim=c(1,max(times),n_strains))
t_start <- 1

for(strain in seq_len(n_strains)){
  t_end <- t_start + 4.5*12 - 1
  foe_pars[,t_start:t_end,strain] <- seasonality[t_start:t_end]
  t_start <- t_end + 1
}
## Specify the force of exposure for exposure ID 1 which represents strain A circulation

## Specify a simple exposure model which calculates the probability of exposure directly from the force of exposure at that time step. In this selected model, the probability of exposure is 1-exp(-FOE) where FOE is the force of exposure at that time.
exposure_model<-exposure_model_simple_FOE
``` 

```{r, fig.dim = c(6, 3)}
## Examine the probability of exposure to each strain over time for the specified exposure model and foe_pars array
plot_exposure_model(exposure_model=exposure_model_simple_FOE, times=times, n_groups = 1, n_exposures = 10, foe_pars=foe_pars) + facet_wrap(~`Exposure ID`)
``` 

# 1.5 Immunity Model
Here, we specify the immunity model which will determine the probability that an 
exposure event is successful in inducing an immunological response. Since we have 
multiple cross-reactive influenza strains we will use 
immunity_model_ifxn_biomarker_prot. With this immunity model, the probability of a 
successful infection depends on the biomarker quantity to all three strains, 
in this case influenza antibody titer, at the time of exposure. 

Additional successful exposure events aka "reinfection" events are representative 
of boosting events. The user can limit the frequency 
of reinfections by adjusting the biomarker-mediated protection 
(also known as titer-mediated protection) parameters or by 
specifying a maximum number of allowed successful exposure events. The 
titer-mediated protection parameters used within this model are defined within 
model_pars which will be loaded in section 1.6. 

Here, we placed no limit on the maximum number of infections to either of the 
three influenza strains however our selected immunity model will take into 
account an individual's current biomarker level when determining the probability 
of a successful infection. 

Our chosen immunity model has an optional argument 
(cross_reactivity_table) which allows users to specify specify whether other 
biomarker quantities are also protective against successful exposure. For this 
example, biomarkers against the infecting strain 
(e.g., exposure_id=strain_a and biomarker_id=biomarker_a) have 100% 
cross-reactivity while other biomarkers have varying levels of cross-reactivity.

Again, the following cross-reactivity and biomarker-mediated protection parameters 
were selected arbitrarily. 
```{r, fig.dim = c(4, 4.5)}
## Specify immunity model within the runserosim function below 
immunity_model<-immunity_model_ifxn_biomarker_prot
## The immunity model we selected will take into account an individual's current biomarker quantity to all three strains and the cross-reactivity between different biomarkers when determining the probability of successful infection. 
```

```{r, fig.dim = c(3, 3)}
## Plot biomarker-mediated protection curve given parameters specified within model_pars for biomarker 1, influenza strain A antibody  (DP_antibody) which will be loaded in section 1.6. Biomarker mediated protection parameters are the same for all 3 influenza strains so the following plot will look the same for all exposure/biomarker types.
plot_biomarker_mediated_protection(seq(0,8,by=0.1), biomarker_prot_midpoint=2.844, biomarker_prot_width=1.299) 
```


# 1.6  Antibody Model and Model Parameters
Now, we specify the antibody model to be used within _runserosim_ to track 
antibody kinetics, or more broadly biomarker kinetics for each biomarker produced 
from successful exposure events. We will be using a monophasic boosting-waning model 
in this example. This model assumes that for each exposure there is a boost and 
boost waning parameter. 

The antibody kinetics parameters are pre-loaded within a csv file. Users can edit 
the csv file to specify their own parameters. All parameters needed for the 
user specified antibody model must be specified within the model_pars. 

Lastly, we define the draw_parameters function which determines how each 
individual’s antibody kinetics parameters are simulated from the within-host 
processes parameters tibble (model_pars). We will use a function which draws 
parameters directly from model_pars for the antibody model with random 
effects to represent individual heterogeneity in immunological responses. 
Parameters are drawn randomly from a distribution with mean and standard 
deviation specified within model_pars. 

_runserosim_ requires that exposure_id and biomarker_id within model_pars are 
numeric and match the exposure to biomarker map so we will use the 
reformat_biomarker_map function again to create a new version of model_pars. 
Users can go directly to numeric model_pars if they wish.
```{r}
## Specify the antibody model 
antibody_model<-antibody_model_monophasic_cross_reactivity

## Antibody model parameters
model_pars_antibody <- tibble(exposure_id = paste0("Strain_",seq_len(n_strains)), biomarker_id=paste0("Biomarker_",seq_len(n_strains))) %>%
    left_join(expand_grid(exposure_id = paste0("Strain_",seq_len(n_strains)), 
                          name=c("boost","wane","biomarker_prot_midpoint","biomarker_prot_width"))) %>%
   left_join(tibble(name=c("boost","wane","biomarker_prot_midpoint","biomarker_prot_width"),
                    mean=c(4,0.01,2.8,1.3),sd=c(1,0.01,NA,NA),
                    distribution=c("log-normal","log-normal",NA,NA)))
model_pars_observation <- tibble(exposure_id=NA, biomarker_id=paste0("Biomarker_",seq_len(n_strains))) %>%
    left_join(expand_grid(biomarker_id=paste0("Biomarker_",seq_len(n_strains)), name=c("obs_sd"))) %>%
   left_join(tibble(name="obs_sd",mean=NA,sd=1,distribution="normal"))

model_pars_original <- bind_rows(model_pars_antibody, model_pars_observation)

## Bring in the antibody parameters needed for the antibody model
## Note that the observation error parameter needed for the observation model (Section 1.7) is defined here too.

## Reformat model_pars for runserosim
model_pars<-reformat_biomarker_map(model_pars_original)
model_pars

## Specify the draw_parameters function
draw_parameters<-draw_parameters_random_fx
```

```{r, fig.dim = c(8, 4)}
## Plot example biomarker trajectories given the specified antibody kinetics model, model parameters and draw parameters function 
plot_antibody_model(antibody_model_monophasic_cross_reactivity, N=25, model_pars=model_pars,draw_parameters_fn = draw_parameters_random_fx, biomarker_map=antigenic_map)
```


# 1.7 Observation Model and observation_times
Now we specify how observed influenza biomarker quantities are generated as a 
probabilistic function of the true, latent biomarker quantity and when to 
observe these quantities. In this step, we specify the sampling design and 
assay choice for our serological survey. We will take samples of all individuals 
at the end of the simulation (t=120). 

Our chosen observation model observes the latent influenza biomarker quantity for all 
three biomarkers given a discrete assay with added noise. The added noise represents 
assay variability and is implemented by sampling from a distribution with the 
true latent biomarker quantity as the mean and the measurement error as the 
standard deviation. The observation standard deviation and distribution are 
defined within model_pars as the “obs_sd” parameter. Within this observation 
model, we can also specify the assay sensitivity and specificity. 
```{r}
## Specify the observation model 
observation_model<-observation_model_discrete_noise

## Specify the cutoffs for the discrete assay. This will depend on the dilutions of the haemagglutination assay.
## This is a matrix with each row containing all of the cutoffs for that biomarker. Here, we have set the same cutoffs for all three biomarkers 
breaks <- seq(0,8,by=1)
cutoffs <- matrix(breaks,nrow=3,ncol=length(breaks), byrow=TRUE)

## Specify assay sensitivity and specificity needed for the observation model
sensitivity<-0.85
specificity<-0.9

## Specify observation_times (serological survey sampling design) to observe all three biomarkers across all individuals at the end of the simulation (t=120)
obs1 <- tibble(i=1:N,t=max(times), b=1)
obs2 <- tibble(i=1:N,t=max(times), b=2)
obs3 <- tibble(i=1:N,t=max(times), b=3)
observation_times<-rbind(obs1,obs2,obs3)
```

# 1.8 Optional Arguments 
There are no optional arguments needed for this simulation. 


# 1.9 Run Simulation 
This is the core simulation where all simulation settings, models and parameters 
are specified within the main simulation function. Run time for this step varies 
depending on the number of individuals and the complexities of the specified models. 
There is a built in pre-computation step within _runserosim_ where the simulation 
attempts to perform as much pre-computation as possible for the exposure model 
to speed up the main simulation code. Users can turn off this pre-computation by 
setting pre-computation to FALSE within _runserosim_.
```{r message=FALSE, warning=FALSE, eval=TRUE}
## Run the core simulation and save outputs in "res"
res<- runserosim(
  simulation_settings=simulation_settings,
  demography=demography,
  observation_times=observation_times,
  foe_pars=foe_pars,
  biomarker_map=antigenic_map,
  model_pars=model_pars,
  exposure_model=exposure_model_simple_FOE,
  immunity_model=immunity_model_ifxn_biomarker_prot,
  antibody_model=antibody_model_monophasic_cross_reactivity,
  observation_model=observation_model_discrete_noise,
  draw_parameters=draw_parameters_random_fx,

  ## Other arguments needed
  cutoffs=cutoffs,
  sensitivity=sensitivity,
  specificity=specificity,
  VERBOSE=10,
  parallel=TRUE,
  n_cores=8
)
## Note that models and arguments specified earlier in the code can be specified directly within this function.
```


# 1.10 Generate Plots
Now that the simulation is complete, let's plot and examine the simulation outputs.
```{r, fig.dim = c(6, 4)} 
## Plot influenza strain A specific biomarker kinetics and exposure histories for 10 individuals 
plot_subset_individuals_history(res$biomarker_states %>% filter(b==1), res$immune_histories_long, subset=10, demography, removal=TRUE)
```

```{r, fig.dim = c(6, 4)} 
## Plot influenza strain B specific biomarker kinetics and exposure histories for 10 individuals 
plot_subset_individuals_history(res$biomarker_states %>% filter(b==2), res$immune_histories_long, subset=10, demography, removal=TRUE)
```

```{r, fig.dim = c(6, 4)} 
## Plot influenza strain C specific biomarker kinetics and exposure histories for 10 individuals 
plot_subset_individuals_history(res$biomarker_states, res$immune_histories_long, subset=10, demography, removal=TRUE)
```

```{r, fig.dim = c(5, 6)} 
## Plot individual probability of exposure for all exposure types.
## This is the output of the exposure model. Note that this reflects our inputs that the influenza strains were never co-circulating.
plot_exposure_force(res$exposure_force_long)
```

```{r, fig.dim = c(5, 6)} 
## Plot individual successful exposure probabilities for all exposure types
## This is the output of the exposure model multiplied by the output of the immunity model.
## In other words, this is the probability of exposure event being successful and inducing an immunological response
plot_exposure_prob(res$exposure_probabilities_long)
```

```{r, fig.dim = c(5, 6)} 
## Plot individual exposure histories for all exposure types
plot_immune_histories(res$immune_histories_long)
```

```{r, fig.dim = c(4, 4.5)} 
## Plot influenza strain A antibody (biomarker 1) states for all individuals (true biomarker quantities)
plot_biomarker_quantity(res$biomarker_states %>% filter(b==1))
```

```{r, , fig.dim = c(4, 4.5)} 
## Plot influenza strain B antibody (biomarker 2) states for all individuals (true biomarker quantities)
plot_biomarker_quantity(res$biomarker_states %>% filter(b==2))
```

```{r, , fig.dim = c(4, 4.5)} 
## Plot influenza strain C antibody (biomarker 3) states for all individuals (true biomarker quantities)
plot_biomarker_quantity(res$biomarker_states %>% filter(b==3))
```

```{r, fig.dim = c(4, 4.5)} 
## Plot the influenza strain A serosurvey results (observed biomarker quantities)
plot_obs_biomarkers_one_sample(res$observed_biomarker_states %>% filter(b==1))
```


```{r, fig.dim = c(4, 4.5)} 
## Plot the influenza strain B serosurvey results (observed biomarker quantities)
plot_obs_biomarkers_one_sample(res$observed_biomarker_states %>% filter(b==2))
```


```{r, fig.dim = c(4, 4.5)} 
## Plot the influenza strain C serosurvey results (observed biomarker quantities)
plot_obs_biomarkers_one_sample(res$observed_biomarker_states %>% filter(b==3))

## Note that the simulated kinetics parameters are also stored
head(res$kinetics_parameters)
```