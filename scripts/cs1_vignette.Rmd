---
title: "Paper case study 1: Measles"
author: "Arthur Menezes"
date: '2022-08-23'
output: html_document
---

Here, we will use the serosim package to generate a measles longitudinal serological survey.
The overall structure and principles discussed within this case study are also applicable to 
other vaccine preventable pathogens. In this simulation, individuals can either be 
vaccinated against measles or naturally infected, or a combination of both. 
Individuals can also be boosted after an initial seroconversion event. 
We will set up each of the required arguments and models for runserosim in 
the order outlined in the methods section of the paper. 

Load necessary packages:
```{r message=FALSE, warning=FALSE,eval=TRUE}
devtools::load_all("~/Documents/GitHub/serosim")
library(tidyverse)
library(data.table)
library(ggplot2)
```


# 1.1 Simulation Settings
We will simulate monthly time steps across a 10 year period. Therefore, we will 
have 120 time steps. Note that these are arbitrary time steps which will need to 
be scaled to the right time resolution to match any time-based parameters used 
later on.

```{r}
## Specify the number of time periods to simulate 
times <- seq(1,120,by=1) 

## Set simulation settings
simulation_settings <- list("t_start"=1,"t_end"=max(times))
```

# 1.2 Population Demography
For this case study, we are not interested in tracking any demography information
but we are interested in tracking individual's birth and removal time. We will 
use the generate_pop_demography function to create the demography tibble needed 
for runserosim. 

Note: The runserosim function, called later on, only requires a demography tibble 
with two columns (individuals and times). 

```{r}
## Specify the number of individuals in the simulation 
N<-100

## Generate the population demography tibble
## See help file for more information on function arguments.
## Limit is set to 0 which allows births to occur until the last time step
## Let's assume that no individuals are removed from the population and set prob_removal to 0
demography <- generate_pop_demography(N, times, limit=0, removal_min=0, removal_max=120, prob_removal=0)

## Examine the generated demography tibble
summary(demography)
```

# 1.3 Antigen Map 
Now, we have to set up the exposure IDs and antigen IDs for our desired simulation. 
Individuals can be measles seropositive either by natural infection or by 
vaccination and we want to track both exposure types separately. 
In this case, we need two exposure IDs and 1 antigen ID. Exposure ID 1 will 
represent natural infection while exposure ID 2 will represent vaccination.
If you wanted to track other antigens like mumps and rubella which are commonly delivered jointly with 
measles vaccination, then you have to add 2 more antigen IDs to the exposure ID representing vaccination. 
Since we are only interested in tracking measles antibody levels across time, we only need 
one antigen ID. 
```{r}
## Create antigen map
antigen_map <- tibble(exposure_id=c(1,2),antigen_id=c(1,1)) 
antigen_map
```


# 1.4 Force of Infection and Exposure Model
Now, we need to specify the lambdas argument which contains the force of infection
for all exposure_IDs across all time steps and groups. We also specify the exposure model 
which will be called within runserosim later. The exposure model will determine
whether an individual is exposed to a specific exposure event.

Since we did not specify different groups within demography, all individuals will 
automatically be assigned group 1. Therefore, we only need 1 row for dimension
1 in lambdas.
```{r}
## Create an empty array to store the force of infection for all exposure types
lambdas <- array(0, dim=c(1,max(times),n_distinct(antigen_map$exposure_id)))

## Specify the force of infection for exposure ID 1 which represents natural infection
lambdas[,,1] <- 0.2

## Specify the force of vaccination for exposure ID 2 which represents vaccination
lambdas[,,2] <- 0.4

## We specified the same value for all time steps within lambdas for simplicity but users will likely have varying numbers to match real world settings. 

## Specify a simple exposure model which calculates the probability of exposure directly from the force of infection at that time step
exposure_model<-exposure_model_simple_FOI
## In this selected model, the probability of exposure is 1-exp(-FOI) where FOI is the force of infection at that time.
```

# 1.5 Immunity Model
Here, we specify the immunity model which will determine whether an exposure 
event is successful or not. Since we have both vaccination and natural infection 
events, we will use immunity_model_vacc_ifxn_titer_prot. With this model, the probability of 
successful vaccination exposure depends on the number of vaccines received 
prior to time t and age at time t while the probability of successful infection is dependent 
on the titer at the time of exposure. The titer-mediated protection parameters used 
within this model are defined within theta which will be loaded in section 1.6. 
Although measles is known to be fully immunizing, an individual can still be 
"reinfected" within this simulation. These "reinfection" events are representative 
of boosting events which can occur if an individual is exposed to measles following 
a vaccination or previous infection. The user can limit the frequency of multiple infections(aka boosting events)
by adjusting the titer-mediated protection parameters within theta.
```{r}
## Specify immunity model within serosim function below 
immunity_model<-immunity_model_vacc_ifxn_titer_prot

## Specify which exposure IDs represent vaccination events 
vacc_exposures<-2

## Specify the age at which an individual is eligible for vaccination (9 months old for measles); note non vaccine exposures are listed as NAs
vacc_age<-c(NA,9)

## Specify the maximum number of vaccines an individual can receive for each exposure types; note non vaccine exposures are listed as NAs
max_vacc_events<-c(NA,1)

## Plot titer-mediated protection curve given parameters specified within theta for antigen 1 which will be loaded in section 1.6
plot_titer_mediated_protection(0:7500, titer_prot_midpoint=5000, titer_prot_width=.001)
```

# 1.6  Antibody Model, Antibody Kinetics Parameters, and draw_parameters
Now, we specify the antibody model to be used within runserosim. We will be using 
a biphasic boosting-waning model. This model assumes that for each exposure there 
is a set of long-term boost, long-term boost waning, short-term boost, and 
short-term boost waning parameters. This model incorporates titer-dependent boosting effects 
by taking an individual's realized boost which is adjusted by draw_parameters.
The antibody kinetics parameters are pre-loaded within a csv file. 
Users can edit the csv file to modify any parameters. All parameters needed for 
the antibody model, must be specified within theta. Lastly, we define
the draw_parameters function which determines how each individual’s antibody kinetics 
parameters are simulated from the antibody kinetics parameters tibble (theta). 
We will use a function which draws parameters directly from theta for the antibody 
model with random effects. Parameters are drawn randomly from a distribution 
with mean and standard deviation specified within theta. This draw_parameters function
also incorporates titer-ceiling effects where an individual’s realized boost is 
dependent on their titer level at the time of the exposure event.
```{r}
## Specify the antibody model 
antibody_model<-antibody_model_biphasic

## Bring in the antibody parameters needed for the antibody model
## Note that the titer-mediated protection parameters needed for the immunity model (Section 1.5), the titer-ceiling parameters needed for draw_parameters and the observation error parameter needed for the observation model (Section 1.7) are all defined here too.
## Also note that these are all arbitrary parameter values loosely informed by plausible values.
theta_path <- system.file("extdata", "theta_cs1.csv", package = "serosim")
theta <- read.csv(file = theta_path, header = TRUE)
theta

## Specify the draw_parameters function to use 
draw_parameters<-draw_parameters_random_fx_titer_dep

## Plot titer dependent boosting effects given parameters specified within theta for antigen 1 (measles)
plot_titer_dependent_boosting(start=0, end=1500, by=1, titer_ceiling_threshold=1000, titer_ceiling_gradient=0.0009)

## These parameters indicate that any individual with a titer level above 1000 at the time of a second exposure event will only receive 10% of the regular boosting parameter for that event 
```

# 1.7 Observation Model and observation_times
Now we specify how observed antibody titers are generated as a probabilistic 
function of the true, latent antibody titer and when to observe these titers.
In this step, users are specifying the sampling design and assay choice for their
serological survey.
We will take samples of all individuals alive at the midpoint (t=60) and end of the 
simulation (t=120). This will provide us with paired samples for all individuals alive 
at the midpoint of the simulation. We will use a continuous assay with lower and 
upper bounds mimicking the measles IgG ELISA with added noise. This observation model 
observes the latent titer values given a continuous assay with user-specified 
lower and upper limits and added noise. The added noise represents assay 
variability and is done by sampling from a distribution with the true latent antibody 
titer as the mean and the measurement error as the standard deviation. The 
observation standard deviation and distribution is defined within theta as the 
“obs_sd” parameter.
```{r}
## Specify the limits of detection for each antigen for the continuous assays
bounds<-tibble(antigen_id=c(1,1),name=c("lower_bound","upper_bound"),value=c(20,20000))

## Specify the observation model 
observation_model<-observation_model_continuous_bounded_noise

## Specify observation_times (serological survey sampling design) to observe antigen 1 (aka measles antibody titer) across all individuals at the midpoint and the end of the simulation (t=60 and t=120)
obs1 <- tibble(i=1:N,t=60, ag=1)
obs2 <- tibble(i=1:N,t=120, ag=1)
observation_times<-rbind(obs1,obs2)
```


# 1.8 Optional Arguments 
There are no optional arguments needed for this simulation. 

# 1.9 Run Simulation 
This is the core simulation where all simulation settings, models and parameters are specified within the main simulation function. Time to run this step varies depending on the number of individuals and the complexities of the specified models. 
```{r message=FALSE, warning=FALSE, eval=TRUE}
## Run the core simulation and save outputs in "res"
res<- runserosim(
  simulation_settings,
  demography,
  observation_times,
  lambdas,
  antigen_map,
  theta,
  exposure_model,
  immunity_model,
  antibody_model,
  observation_model,
  draw_parameters,

  ## Other arguments needed
  bounds=bounds,
  max_vacc_events=max_vacc_events,
  vacc_exposures=vacc_exposures,
  vacc_age=vacc_age,
)

## Note that models and arguments specified earlier in the code can be specified directly within this function.
```

# 1.10 Generate Plots
Now that the simulation is complete, let's plot and examine the simulation outputs.
```{r}
## Plot antibody states and exposure histories for 10 individuals 
plot_subset_individuals_history(res$antibody_states, res$exposure_histories_long, subset=10, demography)

## Plot exposure histories for all exposure types
plot_exposure_histories(res$exposure_histories_long)

## Plot exposure probabilities for all exposure types
plot_exposure_prob(res$exposure_probabilities_long)

## Plot antibody states for all individuals
plot_titers(res$antibody_states)

## Plot the first serosurvey at time 60 
obs60<-res$observed_antibody_states %>% filter(t==60)
plot_obs_titers_one_sample(obs60)

## Plot the second serosurvey at time 120 
obs120<-res$observed_antibody_states %>% filter(t==120)
plot_obs_titers_one_sample(obs120)

## Plot both serosurveys paired samples
plot_obs_titers_paired_sample(res$observed_antibody_states)

## Note that the simulated kinetics parameters are also stored
head(res$kinetics_parameters)

```
