---
title: 'Paper case study 2: Multi-pathogen system with multivalent vaccinaton'
author: "Arthur Menezes"
date: '2022-08-24'
output: html_document
---
Here, we will use the serosim package to generate a cross-sectional serosurvey of 
a multi-pathogen system with multivalent vaccination. The overall structure 
and principles discussed within this case study are applicable to pathogen 
systems like measles, mumps, and rubella with MMR vaccination or diphtheria, 
tetanus, and pertussis system with DTP vaccination among many others.  This 
simulation will track natural infection to pathogen A, natural infection to 
pathogen B and bi-valent vaccination with pathogen A and pathogen B antigens for 
100 individuals across a 10 year period. At the end of the 10 year period, we 
will measure titers against both pathogen A specific antibodies and pathogen B 
specific antibodies for all individuals.
We will set up each of the required arguments and models for runserosim in the 
order outlined in the methods section of the paper. 

Load necessary packages:
```{r message=FALSE, warning=FALSE,eval=TRUE}
devtools::load_all("~/Documents/GitHub/serosim")
library(tidyverse)
library(data.table)
library(ggplot2)
```


# 1.1 Simulation Settings
We will simulate monthly time steps across a 10 year period. Therefore, we will 
have 120 time steps. Note that these are arbitrary time steps which will need to 
be scaled to the right time resolution to match any time-based parameters used 
later on.
```{r}
## Specify the number of time periods to simulate 
times <- seq(1,120,by=1) 

## Set simulation settings
simulation_settings <- list("t_start"=1,"t_end"=max(times))
```

# 1.2 Population Demography
For this case study, we are interested in tracking an individual's socioeconomic 
status, group(a proxy for location), birth and removal time. We will use the 
generate_pop_demography function to create the demography tibble needed for 
runserosim.

Note: The runserosim function, called later on, only requires a demography 
tibble with two columns (individuals and times). 

```{r}
## Specify the number of individuals in the simulation 
N<-100

## Pre load the demography categories, values and distributions 
## Specify options for each demography element and the distribution of each within the population
## We are interested in simulating a population where individuals have varying nutritional status and can reside in either of 2 locations
aux <- list("NS"=list("name"="NS","options"=c("low","medium","high"), "distribution"=c(0.3,0.3,0.4)),
            "Group"=list("name"="group","options"=c("1", "2"), "distribution"=c(0.5,0.5)))


## Generate the population demography tibble
## Limit is set to 0 which allows births to occur until the last time step
## Let's assume that individuals are removed from the population and set prob_removal to 0.2
demography <- generate_pop_demography(N, times, age_min=0, removal_min=0, removal_max=120, prob_removal=0.2, aux=aux)

## Examine the generated demography tibble
head(demography)
tail(demography)
```

# 1.3 Exposure to biomarker mapping
Now, we have to set up the exposure IDs and biomarker IDs for our desired 
simulation. Individuals can be seropositive either by natural infection or by 
vaccination and we want to track both exposure types separately. 
In this case, we need three exposure IDs:

1. Pathogen A and Pathogen B combined vaccine (AB_vacc)
2. Pathogen A natural infection (A_ifxn)
3. Pathogen B natural infection (B_ifxn)

And two biomarker IDs:

1. Pathogen A specific antibodies (A_antibody)
2. Pathogen B specific antibodies (B_antibody)
runserosim requires that exposure_id and biomarker_id are numeric so we will use 
the reformat_biomarker_map function to create a new version of the biomarker map. 
Users can go directly to numeric biomarker_map if they wish.
```{r}
## Create biomarker map
biomarker_map_original <- tibble(exposure_id=c("AB_vacc","AB_vacc","A_ifxn","B_ifxn"),biomarker_id=c("A_antibody","B_antibody","A_antibody","B_antibody"))
biomarker_map_original

## Reformat biomarker_map for runserosim
biomarker_map <-reformat_biomarker_map(biomarker_map_original)
biomarker_map
```

# 1.4 Force of Exposure and Exposure Model
Now, we need to specify the foe_pars argument which contains the force of 
exposure for all exposure_IDs across all time steps. We also specify the 
exposure model which will be called within runserosim later. The exposure model 
will determine the probability that an individual is exposed to a specific 
exposure event. For this example, the probability of exposure (1-e^(-λ)) depends 
on the force of exposure (λ) at the current time t for group g modulated by 
relevant demographic elements (dem_mod) and age (age_mod)

Since we have two groups, there are 2 rows in the first foe_pars dimension.
```{r}
## Create an empty array to store the force of exposure for all exposure types across all time steps and groups
## Dimension 1: Group
## Dimension 2: Times
## Dimension 3: Exposure ID 
foe_pars <- array(0, dim=c(n_distinct(demography$group),max(times), n_distinct(biomarker_map$exposure_id)))

## Note that we can specify a different force of exposure for each group, time and exposure ID
## We specified the same value for all time steps within foe_pars for simplicity but users will likely have varying numbers to match real world settings. 

## Assign arbitrary force of exposure
## Specify the force of exposure for exposure ID 1 which represents Pathogen A and Pathogen B combined vaccine (AB_vacc)
foe_pars[1,,1] <- 0.2 ## Group 1 (aka Group 1)
foe_pars[2,,1] <- 0.3 ## Group 2 (aka Group 2)

## Specify the force of exposure for exposure ID 2 which represents Pathogen A natural infection (A_ifxn)
foe_pars[1,,2] <- 0.4 ## Group 1 (aka Group 1)
foe_pars[2,,2] <- 0.3 ## Group 2 (aka Group 2)

## Specify the force of exposure for exposure ID 2 which represents Pathogen B natural infection (B_ifxn)
foe_pars[1,,3] <- 0.2 ## Group 1 (aka Group 1)
foe_pars[2,,3] <- 0.1 ## Group 2 (aka Group 2)

## Specify a simple exposure model which calculates the probability of exposure from the force of exposure modulated by age and demography elements 
exposure_model<-exposure_model_dem_age_mod

## This exposure model requires age_mod, dem_mod and t_in_year arguments

## Create a tibble with any relevant age modifiers that affect exposure probability 
## Individuals who are less than one years old are 3 times more likely be vaccinated than other age classes
age_mod_1<-tibble(exposure_id=rep(1,11), age=0:10, modifier=c(3,1,1,1,1,1,1,1,1,1,1))

## Individuals who are 0-3 are 2 times more likely to be exposed to pathogen A
age_mod_2<-tibble(exposure_id=rep(2,11), age=0:10, modifier=c(2,2,2,2,1,1,1,1,1,1,1))

## Individuals who are 0-3 are 2 times more likely to be exposed to pathogen B
age_mod_3<-tibble(exposure_id=rep(3,11), age=0:10, modifier=c(1,2,1,1,1,1,1,1,1,1,1))
age_mod<-rbind(age_mod_1,age_mod_2,age_mod_3)
age_mod

## Specify the demography exposure modifiers
## Here, individuals who are of low nutritional status are twice as likely of being exposed to pathogen A and pathogen B while individuals who are of medium nutritional status are 1.5 times as likely of being exposed when compared to individuals of high nutritional status 
## Individuals of high nutritional status are 3 times more likely to be exposed to exposure ID 1 (vaccination) while individuals who are of medium nutritional status are 2 times more likely to be exposed to exposure ID 1 (vaccination) than individuals of low nutritional status. 
## Note that the modifiers must be defined for all combinations of exposure types and demographic elements
dem_mod<-tibble(exposure_id=c(1,1,1,2,2,2,3,3,3), column=rep("NS",times=9), value=rep(c("low","medium", "high"),3), modifier=c(1,2,3,2,1.5,1,2,1.5,1))
dem_mod


## Specify the number of time steps within a year 
## We are simulating on the monthly scale
t_in_year=12
```

# 1.5 Immunity Model
Here, we specify the immunity model which will determine the probability that an 
exposure event is successful. Since we have both vaccination and natural 
infection events, we will use immunity_model_vacc_ifxn_titer_prot. With this 
immunity model, the probability of successful vaccination exposure depends on 
the number of vaccines received prior to time t and the individual's age at time 
t while the probability of successful infection is dependent on the titer at the 
time of exposure. The titer-mediated protection parameters used within this model 
are defined within model_pars which will be loaded in section 1.6. In this 
simulation an individual can still be "reinfected" with either Pathogen A or 
Pathogen B. These "reinfection" events are representative of boosting events 
which can occur if an individual is exposed to either pathogen following a 
vaccination or previous infection. The user can limit the frequency of multiple 
infections(aka boosting events) by adjusting the titer-mediated protection 
parameters within model_pars.
```{r}
## Specify immunity model within the runserosim function below 
immunity_model<-immunity_model_vacc_ifxn_titer_prot

## Specify which exposure IDs represent vaccination events 
## In this case, only exposure ID 1 is a vaccination event
vacc_exposures<-1

## Specify the time step after birth at which an individual is eligible for vaccination (2 months old for AB vaccine); ; note non vaccine exposures are listed as NAs
vacc_age<-c(2,NA,NA)

## Specify the maximum number of vaccines an individual can receive for each exposure types; note non vaccine exposures are listed as NAs
max_vacc_events<-c(1,NA,NA)

## Plot titer-mediated protection curve given parameters specified within model_pars for biomarker 1 (A_antibody) which will be loaded in section 1.6
## The immunity model we selected will take into account an individual's current titer to Pathogen A when determining the probability of successful infection. 
plot_titer_mediated_protection(0:20, titer_prot_midpoint=7, titer_prot_width=.9)

## Plot titer-mediated protection curve given parameters specified within model_pars for biomarker 2 (B_antibody) which will be loaded in section 1.6
## The immunity model we selected will take into account an individual's current titer to Pathogen B when determining the probability of successful infection. 
plot_titer_mediated_protection(0:100, titer_prot_midpoint=50, titer_prot_width=.1)
```

# 1.6  Antibody model and model parameters 
Now, we specify the antibody model to be used within runserosim. We will be 
using a biphasic boosting-waning model.  This model assumes that for each 
exposure there is a set of long-term boost, long-term boost waning, short-term 
boost, and short-term boost waning parameters. This model incorporates titer 
dependent boosting effects by taking an individual's realized boost which is 
adjusted by draw_parameters.The antibody kinetics parameters are pre-loaded 
within a csv file. Users can edit the csv file to adjust any parameters and to 
add/remove exposures and biomarkers. All parameters needed for the antibody model, 
must be specified within model_pars. runserosim requires that exposure_id and 
biomarker_id are numeric within model_pars so we will use the reformat_model_pars 
function to create a new version of model_pars similarly to what we did with the 
biomarker_map argument. Users can go directly to numeric model_pars if they wish. 
Lastly, we define the draw_parameters function which determines how each 
individual’s antibody kinetics parameters are simulated from the within host 
processes parameters tibble (model_pars). We will use a function which draws 
parameters directly from model_pars for the antibody model with random effects. 
Parameters are drawn randomly from a distribution with mean and standard deviation 
specified within model_pars. This draw_parameters function also incorporates 
titer-ceiling effects where an individual’s realized boost is dependent on their 
titer level at the time of the exposure event.
```{r}
## Specify the antibody model 
antibody_model<-antibody_model_biphasic

## Bring in the antibody parameters needed for the antibody model 
## Note that the titer-mediated protection parameters needed for the immunity model, the titer-ceiling parameters needed for draw_parameters and the observation error parameter needed for the observation model are all defined here too.
## Also note that these are all arbitrary parameter values chosen for this toy example.
model_pars_path <- system.file("extdata", "model_pars_cs2.csv", package = "serosim")
model_pars_original <- read.csv(file = model_pars_path, header = TRUE)
model_pars_original 

## Reformat model_pars for runserosim
model_pars<-reformat_model_pars(biomarker_map_original,model_pars_original )
model_pars

## Specify the draw_parameters function to use 
draw_parameters<-draw_parameters_random_fx_titer_dep

## Plot titer dependent boosting effects given parameters specified within model_pars for biomarker 1 (A_antibody)
plot_titer_dependent_boosting(start=0, end=4, by=1, titer_ceiling_threshold=2, titer_ceiling_gradient=0.45)

## These parameters indicate that any individual with a A_antibody titer level above 2 at the time of a second exposure event will only receive 10% of the regular boosting parameter for that event 

## Plot titer dependent boosting effects given parameters specified within model_pars for biomarker 2 (B_antibody)
plot_titer_dependent_boosting(start=0, end=30, by=1, titer_ceiling_threshold=20, titer_ceiling_gradient=0.045)

## These parameters indicate that any individual with a B_antibody titer level above 20 at the time of a second exposure event will only receive 10% of the regular boosting parameter for that event 
```

# 1.7 Observation Model 
Now we specify how observed antibody titers are generated as a probabilistic 
function of the true, latent antibody titer and when to observe these titers. 
In this step, users are specifying the sampling design and assay choice for 
their serological survey. This observation model observes the latent titer values 
given a continuous assay with user-specified lower and upper limits and added 
noise. The added noise represents assay variability and is done by sampling 
from a distribution with the latent antibody titer as the mean and the measurement 
error as the standard deviation. The observation standard deviation and distribution 
is defined within model_pars as the “obs_sd” parameter for each biomarker.
```{r}
## Specify the limits of detection for each biomarker for the continuous assays
bounds<-tibble(biomarker_id=c(1,1,2,2),name=rep(c("lower_bound","upper_bound"),2),value=c(2,50,4,100))

## Specify the observation model 
observation_model<-observation_model_continuous_bounded_noise

## Specify observation_times to observe both biomarkers (aka A_antibody and B_antibody titers) across all individuals at the end of the simulation (t=120)
obs1 <- tibble(i=1:N,t=120, b=1)
obs2 <- tibble(i=1:N,t=120, b=2)
observation_times<-rbind(obs1,obs2)
```


# 1.8 Optional Arguments 
There are no optional arguments needed for this simulation. 

# 1.9 Run Simulation 
This is the core simulation where all simulation settings, models and parameters 
are specified within the main simulation function. Time to run this step varies 
depending on the number of individuals and the complexities of the specified 
models. 
```{r message=FALSE, warning=FALSE, eval=TRUE}
res<- runserosim(
  simulation_settings,
  demography,
  observation_times,
  foe_pars,
  biomarker_map,
  model_pars,
  exposure_model,
  immunity_model,
  antibody_model,
  observation_model,
  draw_parameters,

  ## Other arguments needed
  bounds=bounds,
  max_vacc_events=max_vacc_events,
  vacc_exposures=vacc_exposures,
  vacc_age=vacc_age,
  dem_mod=dem_mod,
  age_mod=age_mod,
  t_in_year=t_in_year
)

## Note that models and arguments specified earlier in the code can be specified directly within this function.
```

# 1.10 Generate Plots
Now that the simulation is complete, let's plot and examine the simulation outputs.
```{r} 
## Plot antibody states and exposure histories for 10 individuals 
plot_subset_individuals_history(res$antibody_states, res$exposure_histories_long, subset=10, demography)

## Plot individual force of exposure for all exposure types
plot_exposure_force(res$exposure_force_long)

## Plot individual exposure probability for all exposure types
plot_exposure_prob(res$exposure_probabilities_long)

## Plot individual exposure histories for all exposure types
plot_exposure_histories(res$exposure_histories_long)

## Plot antibody states for all individuals
plot_titers(res$antibody_states)

## Plot the serosurvey results 
plot_obs_titers_one_sample(res$observed_antibody_states)

## Note that the simulated kinetics parameters are also stored
head(res$kinetics_parameters)
```
