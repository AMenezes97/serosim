<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="serosim">
<title>Case study 4: Using serosim to assess the performance of seroepidemiological inference methods â€¢ serosim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case study 4: Using serosim to assess the performance of seroepidemiological inference methods">
<meta property="og:description" content="serosim">
<meta property="og:image" content="https://amenezes97.github.io/serosim/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">serosim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/case_study_1_measles.html">Case study 1: One pathogen system with vaccination (Measles)</a>
    <a class="dropdown-item" href="../articles/case_study_2_diphtheria_pertussis.html">Case study 2: Multi-pathogen system with multivalent vaccinaton (Diphtheria and Pertussis)</a>
    <a class="dropdown-item" href="../articles/case_study_3_influenza.html">Case study 3: One pathogen system with cross-reactive strains (Influenza)</a>
    <a class="dropdown-item" href="../articles/case_study_4_inference.html">Case study 4: Using serosim to assess the performance of seroepidemiological inference methods</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/AMenezes97/serosim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Case study 4: Using serosim to assess the performance of seroepidemiological inference methods</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/AMenezes97/serosim/blob/HEAD/vignettes/case_study_4_inference.Rmd" class="external-link"><code>vignettes/case_study_4_inference.Rmd</code></a></small>
      <div class="d-none name"><code>case_study_4_inference.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="outline">1.0 Outline<a class="anchor" aria-label="anchor" href="#outline"></a>
</h2>
<p>This vignette demonstrates how serological data simulated from a
complex, realistic <code>serosim</code> model can be used to assess the
accuracy of various seroepidemiological inference methods. The aim is to
compare estimates for key statistics such as incidence, exposure history
and within-host kinetics parameters to their known, true values from a
simulated dataset. This process can help to understand how ignoring key
mechanisms and making simplifying assumptions in the fitted model might
introduce biases and errors into our estimates when fitting to real
data.</p>
<p>Outline:</p>
<ol style="list-style-type: decimal">
<li>Simulate a serological dataset using a moderately complex
<code>serosim</code> model with varying assumptions about immunity and
vaccination.</li>
<li>Estimate the ground-truth force of infection (FOI) using a
serocatalytic model with the <code>serofoi</code> R-package. We will see
well how serocatalytic models are able to re-estimate the FOI despite
using simple classifications for seropositivity which ignore underlying
complexity in the antibody model and immunity model.</li>
<li>Infer individual-level exposures and antibody kinetics parameters
using an infection history reconstruction methods from the
<code>serosolver</code> R-package. We will see that the the
reconstructed infection histories are broadly accurate, but that there
are some slight biases in the inferred antibody kinetics parameters and
attack rates.</li>
</ol>
</div>
<div class="section level2">
<h2 id="motivation">1.1 Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>Serological data is commonly used to estimate past epidemiological
dynamics. The presence of antibodies against a pathogen are indicative
of prior exposure (either through vaccination or infection), and thus
the level, kinetics and distribution of antibody measurements across
time and age can be used to inform periods of high and low exposure
rates. Virtually all approaches to inference using serology are
underpinned by the same simple model: individuals become seropositive at
some rate proportional to the FOI (which might vary over time), and
remain seropositive for some duration governed by an assumed within-host
model. Inference methods range in their complexity, from simple models
assuming a constant FOI over time and life-long seropositivity, to
time-varying FOI with nested within-host models accounting for antibody
boosting and waning kinetics.</p>
<p>However, even the most complex models are simplifications of reality.
The model being fitted to the data will always be misspecified, as it is
infeasible to accurately capture all mechanisms underpinning the
data-generating process, both in terms of epistemology and
identifiability issues when estimating model parameters. Regardless, we
still aim to fit models and perform useful inferences from our data. It
is therefore important to understand if estimates using simple
<em>fitted</em> models are reliable despite knowing that many of the
true underlying <em>generative</em> mechanisms are ignored.</p>
<div class="section level3">
<h3 id="setup">1.2 Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>We will use the outputs of <code>serosim</code> with three R-packages
for estimating epidemic dynamics using serological data. These are <a href="https://epiverse-trace.github.io/serofoi/index.html" class="external-link"><code>serofoi</code></a>
and <a href="https://seroanalytics.github.io/serosolver/" class="external-link"><code>serosolver</code></a>.
<code>serofoi</code> uses the <code>rstan</code> package to estimate the
FOI by fitting serocatalytic models to age-stratified seroprevalence
data, whereas <code>serosolver</code> uses a custom Markov chain Monte
Carlo (MCMC) algorithm to estimate exposure histories, attack rates and
parameters of a simple antibody kinetics using individual-level antibody
titer data. Please refer to <a href="https://epiverse-trace.github.io/serofoi/index.html" class="external-link"><code>serofoi</code></a>
and <a href="https://seroanalytics.github.io/serosolver/" class="external-link"><code>serosolver</code></a>
websites for more information.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-serosim-to-generate-a-synthetic-dataset">2. Using serosim to generate a synthetic dataset<a class="anchor" aria-label="anchor" href="#using-serosim-to-generate-a-synthetic-dataset"></a>
</h2>
<div class="section level3">
<h3 id="simulation-settings-demography-and-biomarker-map">2.1 Simulation settings, demography and biomarker map<a class="anchor" aria-label="anchor" href="#simulation-settings-demography-and-biomarker-map"></a>
</h3>
<p>We will simulate a generic serological study of 1000 individuals of
varying ages split across two locations, one with a high FOI that
decreases over time and the other with relatively low FOI that increases
over time. The simulation period will be run at an annual resolution
(i.e., individuals can get infected once per year) for 50 years. We
assume that 70% of the population are in an urban setting and 30% in a
rural setting.</p>
<p>We will assume that the we only measure one biomarker type (IgG)
which can be boosted through either natural infection or vaccination.
For the first simulation, we will assume that there is no vaccination,
and then see how well the inference methods perform when vaccination is
included in the simulation, but not the inference model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Specify the number of time periods to simulate </span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">50</span>,by<span class="op">=</span><span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">simulation_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"t_start"</span><span class="op">=</span><span class="fl">1</span>,<span class="st">"t_end"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Generate the population demography tibble</span></span>
<span><span class="co">## Specify the number of individuals in the simulation; N=1000</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co">## Assign individuals into either urban or rural location</span></span>
<span><span class="va">aux_demography</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Group"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"name"</span><span class="op">=</span><span class="st">"location"</span>,<span class="st">"options"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Urban"</span>,<span class="st">"Rural"</span><span class="op">)</span>,<span class="st">"distribution"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>,<span class="fl">0.3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">demography</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_pop_demography.html">generate_pop_demography</a></span><span class="op">(</span>N<span class="op">=</span><span class="va">N</span>, times<span class="op">=</span><span class="va">times</span>,aux<span class="op">=</span><span class="va">aux_demography</span>,age_min<span class="op">=</span><span class="fl">0</span>,prob_removal<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i)`</span></span>
<span><span class="va">demography</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">demography</span><span class="op">$</span><span class="va">location</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Urban"</span>,<span class="st">"Rural"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co">## Convert the location ID to the group ID for the main simulation.</span></span>
<span></span>
<span><span class="co">## Vaccination will be determined by age and doses, not dependent on biomarker quantity</span></span>
<span><span class="va">max_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">2</span><span class="op">)</span> <span class="co">## Maximum of 10 exposure ID 1 events (infection), and 2 exposure ID 2 events (vaccination).</span></span>
<span><span class="va">vacc_exposures</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co">## Vaccination is the 2nd exposure ID</span></span>
<span><span class="va">vacc_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">2</span><span class="op">)</span> <span class="co">## Individuals can be infected at any age (vacc_age[1] = NA), but only vaccinated once they reach 2 years old (vacc_age[2]=2)</span></span>
<span></span>
<span><span class="co"># Create simple biomarker map</span></span>
<span><span class="va">biomarker_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>exposure_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ifxn"</span>,<span class="st">"vacc"</span><span class="op">)</span>,biomarker_id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"IgG"</span>,<span class="st">"IgG"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Reformat biomarker_map for runserosim</span></span>
<span><span class="va">biomarker_map</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/reformat_biomarker_map.html">reformat_biomarker_map</a></span><span class="op">(</span><span class="va">biomarker_map</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exposure-model-and-the-force-of-infection">2.2 Exposure model and the force of infection<a class="anchor" aria-label="anchor" href="#exposure-model-and-the-force-of-infection"></a>
</h3>
<p>We assume a time-varying FOI in each of the 50-year time periods,
where the FOI is decreasing over time in one region, but increasing and
twice as high overall in the other region. This provides a slightly
complex ground truth for the inference methods to recover. For now, we
will assume that there is no vaccination, but will relax this assumption
later.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create an empty array to store the force of exposure for all exposure types</span></span>
<span><span class="co"># Dimension 1: location</span></span>
<span><span class="co"># Dimension 2: time</span></span>
<span><span class="co"># Dimension 3: exposure ID</span></span>
<span><span class="va">foe_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>,<span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">biomarker_map</span><span class="op">$</span><span class="va">exposure_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Specify the force of exposure for Location 1 (urban), Exposure ID 1 which represents natural infection</span></span>
<span><span class="va">foe_pars</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">20</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.025</span>,<span class="fl">15</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#foe_pars[1,,1] &lt;-0.03</span></span>
<span></span>
<span><span class="co">## Specify the force of exposure for Location 2 (rural), Exposure ID 1 which represents natural infection</span></span>
<span><span class="va">foe_pars</span><span class="op">[</span><span class="fl">2</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>,<span class="fl">20</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.025</span>,<span class="fl">15</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#foe_pars[2,,1] &lt;- 0.06</span></span>
<span></span>
<span><span class="co">## Specify a simple exposure model which calculates the probability of exposure </span></span>
<span><span class="co">## directly from the force of exposure at that time step. In this selected model, </span></span>
<span><span class="co">## the probability of exposure is 1-exp(-FOE) where FOE is the force of exposure at that time.</span></span>
<span><span class="va">exposure_model</span><span class="op">&lt;-</span><span class="va">exposure_model_simple_FOE</span></span>
<span></span>
<span><span class="co">## Examine the probability of exposure over time for the specified exposure model and foe_pars array</span></span>
<span><span class="fu"><a href="../reference/plot_exposure_model.html">plot_exposure_model</a></span><span class="op">(</span>exposure_model<span class="op">=</span><span class="va">exposure_model_simple_FOE</span>, times<span class="op">=</span><span class="va">times</span>, </span>
<span>                    n_groups <span class="op">=</span> <span class="fl">2</span>, n_exposures <span class="op">=</span> <span class="fl">2</span>, foe_pars<span class="op">=</span><span class="va">foe_pars</span><span class="op">)</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="antibody-and-immunity-models">2.3 Antibody and immunity models<a class="anchor" aria-label="anchor" href="#antibody-and-immunity-models"></a>
</h3>
<p>The inference methods we will be using (<code>serofoi</code>,
<code>Rsero</code> and <code>serosolver</code>) have embedded models
(whether explicit or implicit) for seroconversion or expected antibody
level as a function fo time-since-infection. The serocatalytic model of
<code>serofoi</code> makes the simplest assumption that individuals
become seropositive indefinitely following exposure, though extensions
of the serocatalytic model such as those in <code>Rsero</code> can also
account for seroreversion. The <code>serosolver</code> model is slightly
more complicated with an embedded boosting and waning model, though
under the assumption that all post-exposure kinetics are governed by the
same magnitude of boost and wane. In reality, there is substantial
heterogeneity in post-exposure antibody kinetics, and thus here we
simulate a boosting and monophasic waning antibody process with random
effects on the individual boosting and waning rate parameters (i.e., the
kinetics of each exposure are governed by a randomly drawn set of
parameter values). For the immunity model, we will assume that
individuals have fairly strong antibody-mediated immunity.</p>
<p>We assume that post-infection antibody boosts are log-normally
distributed with a mean of 4 and a standard deviation (on the log scale)
of 2. This boost wanes at approximately 0.008 units per year
(log-normally distributed, standard deviation of 0.025).
Post-vaccination boosts are assumed to be lower with a mean boost of 2
units (log-normally distributed, standard deviation of 1), and wane
slower at a rate of 0.005 units per year (log-normally distributed,
standard deviation of 0.025). Although it takes a long time for most
individuals to serorevert, the individual-level heterogeneity means that
some individuals wane from seropositive to seronegative levels within
the time frame of the simulation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Assume that immunity from infection is dependent on latent biomarker level at time of exposure</span></span>
<span><span class="va">p_immunity</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_biomarker_mediated_protection.html">plot_biomarker_mediated_protection</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">8</span>,by<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Tibble of model parameter controls related to infection immunity</span></span>
<span><span class="va">model_pars_immunity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">"exposure_id"</span><span class="op">=</span><span class="st">"ifxn"</span>,<span class="st">"biomarker_id"</span><span class="op">=</span><span class="st">"IgG"</span>,</span>
<span>                              <span class="st">"name"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"biomarker_prot_midpoint"</span>,<span class="st">"biomarker_prot_width"</span><span class="op">)</span>,</span>
<span>                              <span class="st">"mean"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,<span class="st">"sd"</span><span class="op">=</span><span class="cn">NA</span>,<span class="st">"distribution"</span><span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="co">## See example in help file</span></span>
<span><span class="va">immunity_model</span> <span class="op">&lt;-</span> <span class="va">immunity_model_vacc_ifxn_biomarker_prot</span></span>
<span></span>
<span><span class="co">## Specify the antibody model </span></span>
<span><span class="va">antibody_model</span><span class="op">&lt;-</span><span class="va">antibody_model_monophasic</span></span>
<span></span>
<span><span class="co">## Bring in the antibody parameters needed for the antibody model</span></span>
<span><span class="va">model_pars_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"model_pars_README.csv"</span>, package <span class="op">=</span> <span class="st">"serosim"</span><span class="op">)</span></span>
<span><span class="va">model_pars_original</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">model_pars_path</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">model_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reformat_biomarker_map.html">reformat_biomarker_map</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">model_pars_original</span>,<span class="va">model_pars_immunity</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">1</span>,<span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.008</span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">2</span>,<span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.005</span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span>,<span class="st">"sd"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.025</span></span>
<span><span class="co">## Specify the draw_parameters function</span></span>
<span><span class="va">draw_parameters</span><span class="op">&lt;-</span><span class="va">draw_parameters_random_fx</span></span>
<span></span>
<span><span class="co">## Plot example biomarker trajectories given the specified antibody kinetics model, </span></span>
<span><span class="co">## model parameters and draw parameters function </span></span>
<span><span class="va">p_antibody</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_antibody_model.html">plot_antibody_model</a></span><span class="op">(</span><span class="va">antibody_model_monophasic</span>, N<span class="op">=</span><span class="fl">100</span>, model_pars<span class="op">=</span><span class="va">model_pars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                    draw_parameters_fn <span class="op">=</span> <span class="va">draw_parameters_random_fx</span>, </span>
<span>                    biomarker_map<span class="op">=</span><span class="va">biomarker_map</span><span class="op">)</span></span>
<span><span class="va">p_immunity</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Relationship between pre-exposure biomarker level\n and probability of infection"</span><span class="op">)</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_antibody</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"100 randomly drawn post-exposure biomarker trajectories"</span><span class="op">)</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-5-2.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="observation-model">2.4 Observation model<a class="anchor" aria-label="anchor" href="#observation-model"></a>
</h3>
<p>Finally, we must define the sampling frame and characteristics of the
diagnostic test. We assume that there is a reasonable amount of
measurement error to introduce a degree of misclassification
(observations are normally distributed around the true biomarker level
with upper and lower bounds), and that the assay has imperfect
sensitivity and specificity. We will simulated the scenario where each
individual has two serum samples taken: one in the 48th year of the
simulation, the other in the 50th and final year.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Specify the observation model </span></span>
<span><span class="va">observation_model</span><span class="op">&lt;-</span><span class="va">observation_model_continuous_bounded_noise</span></span>
<span></span>
<span><span class="co">## Specify assay sensitivity and specificity needed for the observation model</span></span>
<span><span class="va">model_pars_original</span><span class="op">[</span><span class="va">model_pars_original</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span><span class="st">"obs_sd"</span>,<span class="st">"sd"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">sensitivity</span><span class="op">&lt;-</span><span class="fl">0.85</span></span>
<span><span class="va">specificity</span><span class="op">&lt;-</span><span class="fl">0.95</span></span>
<span></span>
<span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>biomarker_id<span class="op">=</span><span class="fl">1</span>,name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lower_bound"</span>,<span class="st">"upper_bound"</span><span class="op">)</span>,value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Specify observation_times (serological survey sampling design) to observe</span></span>
<span><span class="co">## biomarker 1 at two time points around t 80 and 110</span></span>
<span><span class="va">observation_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>i<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">demography</span><span class="op">$</span><span class="va">i</span><span class="op">)</span>,each<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">48</span>,<span class="fl">50</span><span class="op">)</span>,<span class="va">N</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="serosim-run">2.5 <code>serosim</code> run<a class="anchor" aria-label="anchor" href="#serosim-run"></a>
</h3>
<p>With all of the models and parameters in place, we now run the
simulation. Inspect the <code>res</code> object to see some
visualizations of the ground-truth simulation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Run the core simulation and save outputs in "res"</span></span>
<span><span class="va">res</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/runserosim.html">runserosim</a></span><span class="op">(</span></span>
<span>  <span class="va">simulation_settings</span>,</span>
<span>  <span class="va">demography</span>,</span>
<span>  <span class="va">observation_times</span>,</span>
<span>  <span class="va">foe_pars</span>,</span>
<span>  <span class="va">biomarker_map</span>,</span>
<span>  <span class="va">model_pars</span>,</span>
<span>  <span class="va">exposure_model</span>,</span>
<span>  <span class="va">immunity_model</span>,</span>
<span>  <span class="va">antibody_model</span>,</span>
<span>  <span class="va">observation_model</span>,</span>
<span>  <span class="va">draw_parameters</span>,</span>
<span>  </span>
<span>  <span class="co">## Other arguments needed</span></span>
<span>  bounds<span class="op">=</span><span class="va">bounds</span>,</span>
<span>  max_events<span class="op">=</span><span class="va">max_events</span>,</span>
<span>  vacc_exposures<span class="op">=</span><span class="va">vacc_exposures</span>,</span>
<span>  vacc_age<span class="op">=</span><span class="va">vacc_age</span>,</span>
<span>  sensitivity<span class="op">=</span><span class="va">sensitivity</span>,</span>
<span>  specificity<span class="op">=</span><span class="va">specificity</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i, t)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i)`</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="estimating-the-force-of-infection-using-a-serocatalytic-model">3.0 Estimating the force of infection using a serocatalytic
model<a class="anchor" aria-label="anchor" href="#estimating-the-force-of-infection-using-a-serocatalytic-model"></a>
</h2>
<p>Our first aim is to see how well our serological study design allows
us to estimate the ground-truth FOI over time. There are many methods
for estimating the FOI from serological data, but the most commonly used
is the serocatalytic model. Serocatalytic models make the assumption
that individuals become seropositive at a rate proportional to the FOI,
and thus over a long period of time, the age-stratified distribution of
seroprevalence is related to the FOI as:</p>
<p><span class="math display">\[
P(a, t) = 1-exp(-\sum_{i=t-a+1}^t \lambda_i)
\]</span> where <span class="math inline">\(\lambda_i\)</span> is the
FOI in year <span class="math inline">\(i\)</span> and <span class="math inline">\(P(a,t)\)</span> is the seroprevalence of age group
<span class="math inline">\(a\)</span> at time <span class="math inline">\(t\)</span>. We will use the <code>serofoi</code>
package to fit this model to our simulated serological study data,
noting that the simple fitted model does not explictly account for the
kinetics of the antibody response nor the imperfect performance of the
antibody assay. Furthermore, the serocatalytic model fits to
<em>seropositivity</em> data rather than antibody level. Thus, we can
also explore the consequences of using different thresholds to classify
individuals as seropositive or seronegative.</p>
<div class="section level3">
<h3 id="running-the-serofoi-package">3.1 Running the <code>serofoi</code> package<a class="anchor" aria-label="anchor" href="#running-the-serofoi-package"></a>
</h3>
<p>We load the <code>serofoi</code> package, clean our simulated dataset
into the format expected by the main <code>serofoi</code> functions, and
then attempt to re-estimate the ground-truth FOI in our two study
locations. We use the time-varying FOI model from <code>serofoi</code>,
which allows the FOI to vary over time using a random-walk prior to
allow the FOI to change smoothly over time. We only take the latest
serum sample for each individual, though note that more complex
serocatalytic models can combine multiple observations per person or
cross-sections.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://trace-lac.github.io/serofoi/" class="external-link">serofoi</a></span><span class="op">)</span></span>
<span><span class="co">## Pull our the observed biomarker states and combine with the demography data to get each individual's age</span></span>
<span><span class="va">serodat</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">observed_biomarker_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">t</span>, <span class="va">observed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">t</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">demog</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">birth</span>, <span class="va">location</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">serodat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">serodat</span>, <span class="va">demog</span>, by<span class="op">=</span><span class="st">"i"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Create a custom function for summarizing the simulated serosurvey data into seroprevalence by age,</span></span>
<span><span class="co">## then fit the serocatalytic model to the Rural and Urban location data.</span></span>
<span><span class="va">fit_serofoi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">seropos_cutoff</span> <span class="op">=</span> <span class="fl">1.5</span>, <span class="va">serodat</span>, <span class="va">true_foi</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">summary</span> <span class="op">&lt;-</span> <span class="va">serodat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">t</span> <span class="op">-</span> <span class="va">birth</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>seropos<span class="op">=</span><span class="va">observed</span> <span class="op">&gt;=</span> <span class="va">seropos_cutoff</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">location</span>, <span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,counts<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">seropos</span><span class="op">)</span>,.groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age_min <span class="op">=</span> <span class="va">age</span>, age_max<span class="op">=</span><span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>test<span class="op">=</span><span class="st">"sim"</span>,antibody<span class="op">=</span><span class="st">"IgG"</span>,country<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>tsur<span class="op">=</span><span class="va">t</span>, survey<span class="op">=</span><span class="va">location</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">serodat_rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/prepare_serodata.html" class="external-link">prepare_serodata</a></span><span class="op">(</span><span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey</span><span class="op">==</span><span class="st">"Rural"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model_rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/run_seromodel.html" class="external-link">run_seromodel</a></span><span class="op">(</span><span class="va">serodat_rural</span>,foi_model <span class="op">=</span> <span class="st">"tv_normal"</span>,n_iters<span class="op">=</span><span class="fl">3000</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p_rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/plot_seromodel.html" class="external-link">plot_seromodel</a></span><span class="op">(</span><span class="va">model_rural</span>, size_text <span class="op">=</span> <span class="fl">8</span>,foi_sim<span class="op">=</span><span class="va">true_foi</span><span class="op">[</span><span class="fl">2</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">serodat_urban</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/prepare_serodata.html" class="external-link">prepare_serodata</a></span><span class="op">(</span><span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">survey</span><span class="op">==</span><span class="st">"Urban"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model_urban</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/run_seromodel.html" class="external-link">run_seromodel</a></span><span class="op">(</span><span class="va">serodat_urban</span>,foi_model <span class="op">=</span> <span class="st">"tv_normal"</span>,n_iters<span class="op">=</span><span class="fl">3000</span><span class="op">)</span></span>
<span>  <span class="va">p_urban</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serofoi/man/plot_seromodel.html" class="external-link">plot_seromodel</a></span><span class="op">(</span><span class="va">model_urban</span>, size_text <span class="op">=</span> <span class="fl">8</span>,foi_sim<span class="op">=</span><span class="va">true_foi</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">p_rural</span> <span class="op">|</span> <span class="va">p_urban</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Compare results for different seropositivity thresholds</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">fit_serofoi</span><span class="op">(</span><span class="fl">1.25</span>,<span class="va">serodat</span>, <span class="va">foe_pars</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">fit_serofoi</span><span class="op">(</span><span class="fl">2</span>,<span class="va">serodat</span>, <span class="va">foe_pars</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Seropositivity threshold of 1.25</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Seropositivity threshold of 2</span></span>
<span><span class="va">p2</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-8-2.png" width="672">
Each set of plots shows the results from fitting the serocatalytic model
under different thresholds for classifying individuals as seropositive
(antibody measurement above 1.25 or 2). Within each set of 6 subplots,
the top subplots show the model fits to the age-stratified
seroprevalence data, whereas the middle subplots show the posteriors for
estimated FOI (blue ribbon and solid line) compared to the ground-truth
(solid red line). The bottom subplots show the convergence diagnostics
(all black dots should be below the blue line).</p>
<p>The output plots from <code>serofoi</code> show that the model
provides FOI estimates that are of roughly the right magnitude and fit
the seroprevalence data well. The model also detects the directional
change of the FOI in the two populations, but does not fully recapture
the variation in FOI over time. The fits from the different
seropositivity thresholds do not appear to substantially change the fits
nor FOI estimates (perhaps the estimates from the higher threshold are
lower), though we can see some small differences in model fits based on
the expected log-predictive densities (the ELPD numbers in each plotâ€™s
text; smaller values roughly correspond to better model predictive
performance).</p>
<p>As an exercise for the reader, we can check that a large part of the
problem is due to antibody waning, which results in misclassifying some
previously seropositive individuals as seronegative by year 50. Try
making the model parameters for the waning rates much smaller (see
snippet below) and then re-running all of the code up to this point. You
should see that the estimated FOIs more closely correspond to the true
FOI (blue vs.Â red lines). You might also try increasing the sample size
or age distribution of the cohort, and increasing the sensitivity and
specificity of the observation process.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Make the antibody waning rates one order of magnitude slower with little variation</span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">1</span>,<span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.0008</span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">2</span>,<span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.0005</span></span>
<span><span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span>,<span class="st">"sd"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.00025</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-vaccination-to-the-simulation-and-re-running-serofoi">3.2 Adding vaccination to the simulation and re-running
<code>serofoi</code><a class="anchor" aria-label="anchor" href="#adding-vaccination-to-the-simulation-and-re-running-serofoi"></a>
</h3>
<p>For many pathogens, particularly vaccine-preventable diseases, it can
be difficult to interpret serological data when antibody levels are
elevated both through natural exposure and vaccination. Letâ€™s see how
including vaccination in the simulation affects the inferred FOI of
natural infection in the two regions. We will assume that the
vaccination rate is very high in the Urban location but very low in the
Rural location. In reality, if vaccination rates were this high then we
would likely not attempt to interpret the FOI estimates from the simple
serocatalytic model. But for illustration purposes, we can see how
failing to account for vaccination will lead to significantly biased FOI
estimates.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Specify the force of exposure for exposure ID 2 which represents vaccination</span></span>
<span><span class="va">foe_pars</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">foe_pars</span><span class="op">[</span><span class="fl">2</span>,,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_exposure_model.html">plot_exposure_model</a></span><span class="op">(</span>exposure_model<span class="op">=</span><span class="va">exposure_model_simple_FOE</span>, times<span class="op">=</span><span class="va">times</span>, </span>
<span>                    n_groups <span class="op">=</span> <span class="fl">2</span>, n_exposures <span class="op">=</span> <span class="fl">2</span>, foe_pars<span class="op">=</span><span class="va">foe_pars</span><span class="op">)</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Run the core simulation and save outputs in "res"</span></span>
<span><span class="va">res_vaccination</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runserosim.html">runserosim</a></span><span class="op">(</span><span class="va">simulation_settings</span>,<span class="va">demography</span>,<span class="va">observation_times</span>,</span>
<span>  <span class="va">foe_pars</span>,<span class="va">biomarker_map</span>,<span class="va">model_pars</span>,</span>
<span>  <span class="va">exposure_model</span>,<span class="va">immunity_model</span>,<span class="va">antibody_model</span>,<span class="va">observation_model</span>,</span>
<span>  <span class="va">draw_parameters</span>,bounds<span class="op">=</span><span class="va">bounds</span>,max_events<span class="op">=</span><span class="va">max_events</span>,</span>
<span>  vacc_exposures<span class="op">=</span><span class="va">vacc_exposures</span>,vacc_age<span class="op">=</span><span class="va">vacc_age</span>,</span>
<span>  sensitivity<span class="op">=</span><span class="va">sensitivity</span>,specificity<span class="op">=</span><span class="va">specificity</span><span class="op">)</span></span>
<span></span>
<span><span class="va">serodat_vaccine</span> <span class="op">&lt;-</span> <span class="va">res_vaccination</span><span class="op">$</span><span class="va">observed_biomarker_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">t</span>, <span class="va">observed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">t</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">demog</span> <span class="op">&lt;-</span> <span class="va">res_vaccination</span><span class="op">$</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">birth</span>, <span class="va">location</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">serodat_vaccine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">serodat_vaccine</span>, <span class="va">demog</span>, by<span class="op">=</span><span class="st">"i"</span><span class="op">)</span> </span>
<span><span class="va">p_vaccine_foi</span> <span class="op">&lt;-</span> <span class="fu">fit_serofoi</span><span class="op">(</span><span class="fl">2</span>,<span class="va">serodat_vaccine</span>, <span class="va">foe_pars</span><span class="op">)</span></span>
<span><span class="va">p_vaccine_foi</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>We can see that although the fits to the Rural dataset are fairly
accurate, the model drastically overestimates the FOI in recent years
for the Urban location. This is because the vaccination rate is so high
that almost all individuals become seropositive within the first decade
of life, and thus seropositivity alone cannot be used to estimate the
FOI in the Urban location.</p>
</div>
<div class="section level3">
<h3 id="summary">3.4 Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p>In this section, we showed how FOI estimates from a simple catalytic
model fitted to age-stratified seroprevalence data may be inaccurate or
even biased if we fail to account for key mechanisms of the
data-generating process (namely antibody waning in this case). An
iterative approach of comparing estimates from the fitted model to
ground truth from the simulation can be used to guide development of
minimum acceptable inference models. From this analysis, we might
consider refining the serocatalytic model in <code>serofoi</code> to
include seroreversion, or use an alternative tool (e.g., the <a href="https://github.com/nathoze/Rsero" class="external-link"><code>Rsero</code></a> R-package
also fits serocatalytic models using <code>rstan</code>, but allows for
the possibility of seroreversion).</p>
</div>
</div>
<div class="section level2">
<h2 id="estimating-exposure-histories-attack-rates-and-antibody-kinetics-using-serosolver">4.0 Estimating exposure histories, attack rates and antibody
kinetics using <code>serosolver</code><a class="anchor" aria-label="anchor" href="#estimating-exposure-histories-attack-rates-and-antibody-kinetics-using-serosolver"></a>
</h2>
<p>Our next inference method uses the <a href="https://github.com/seroanalytics/serosolver" class="external-link"><code>serosolver</code></a>
package to estimate not only which individuals have been exposed, but
also <em>when</em> each exposure event occurred. Like
<code>serofoi</code>, <code>serosolver</code> uses a Markov chain Monte
Carlo algorithm (MCMC) (in this case, a custom MCMC algorithm rather
than <code>rstan</code>) to estimate model parameters conditional on the
serological data. This approach differs in three ways from the
serocatalytic model:</p>
<ol style="list-style-type: decimal">
<li>Rather than classify each individual as seropositive or
seronegative, we estimate the probability that each individual has been
exposed conditional on all of their antibody titer measurements.</li>
<li>We estimate how many exposures each individual has experienced and
the timing of each exposure conditional on their antibody titer
measurements.</li>
<li>The model estimates parameters of the measurement error process, and
antibody boosting and waning dynamics through an embedded antibody
kinetics model.</li>
</ol>
<p>The aim of this experiment is to test how well the
<code>serosolver</code> model re-estimates the ground-truth exposure
histories and antibody kinetics parameters from <code>serosim</code>.
The key point is that the although the <code>serosolver</code> model
qualitatively describes the same behaviour as the <code>serosim</code>
model (monophasic boosting and waning with observation error), it
neglects some of the mechanisms underpinning the data-generating process
(antibody-mediated immunity, individual-level heterogeneity in boosting
and waning, false negatives and positives, different antibody kinetics
between infection and vaccination). We can then understand how this
model misspecification and oversimplification introduces error and bias
into the statistics we are ultimately interested in using real data â€“
the estimated exposure histories.</p>
<div class="section level3">
<h3 id="setup-1">4.1 Setup<a class="anchor" aria-label="anchor" href="#setup-1"></a>
</h3>
<p>First, we ensure that the <code>serosolver</code> package is loaded,
set up a local cluster to run multiple MCMC chains in parallel, and
create empty directories to store the <code>serosolver</code>
outputs.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/seroanalytics/serosolver" class="external-link">serosolver</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_name</span> <span class="op">&lt;-</span> <span class="st">"serosim_recovery"</span> <span class="co">## Name to give to created files</span></span>
<span><span class="va">main_wd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create a directory to store the MCMC chains</span></span>
<span><span class="va">chain_wd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">main_wd</span>,<span class="st">"/chains/"</span>,<span class="va">run_name</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">chain_wd</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">chain_wd</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#options(mc.cores=5)</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co">## Number of MCMC chains to run</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">main_wd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"In directory: "</span>, <span class="va">main_wd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "In directory: /Users/arthur/Documents/GitHub/serosim/vignettes"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Saving to: "</span>, <span class="va">chain_wd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Saving to: /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery"</span></span>
<span></span>
<span><span class="co">## Run multiple chains in parallel</span></span>
<span><span class="co">## R CMD check only allows a maximum of two cores </span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">registerDoParallel</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will pull the serological data from the <code>serosim</code>
output object (<code>res</code>) and use a custom function
(<code>convert_serodata_to_serosolver</code>, defined in this vignette
in a hidden codeblock above). We merge this with the demography table to
denote which location each individual is in.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Some data cleaning to convert the serosim output into the format expected by serosolver</span></span>
<span><span class="va">sero_data</span> <span class="op">&lt;-</span> <span class="fu">convert_serodata_to_serosolver</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">observed_biomarker_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">times</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span>,by<span class="op">=</span><span class="st">"i"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Note each individual's group/location</span></span>
<span><span class="va">sero_data</span> <span class="op">&lt;-</span> <span class="va">sero_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>individual<span class="op">=</span><span class="va">i</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"individual"</span><span class="op">)</span></span></code></pre></div>
<p>The next stage is a little bit trickier, as we need to make some
tweaks to the <code>serosolver</code> inputs. First, weâ€™ll read in the
parameter table of the <code>serosolver</code> model (NOTE: different to
the <code>serosim</code> parameter table above). Please refer to the <a href="https://github.com/seroanalytics/serosolver" class="external-link"><code>serosolver</code>
vignettes</a> for more information. Briefly, <code>par_tab</code> tells
<code>serosolver</code> which parameters are fixed and which are meant
to be estimated using the <code>fixed</code> variable
(<code>fixed=0</code> denotes an estimated parameter), as well as their
value (if fixed) and upper and lower bounds.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Set up parameter table</span></span>
<span><span class="va">par_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"par_tab_base.csv"</span>,stringsAsFactors<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We will make some assumptions and simplifications about the epidemic
model. <code>serosolver</code> assumes that each individual may or may
not be exposed in each time window of the model, and the exposure states
are independent between time periods (i.e., the exposure state is a
Bernoulli random variable as in <code>serosim</code>). A beta prior is
placed on the per-time probability of exposure for all individuals,
controlled by two parameters â€“ we can adjust these parameters to adjust
the attack rate prior.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## These are the alpha and beta priors on the Beta distribution prior on the per-time attack rate. </span></span>
<span><span class="co">## Set to 1/1 for uniform, can e.g., set to 1/100 to represent a strong prior on low per-time attack rate.</span></span>
<span><span class="va">par_tab</span><span class="op">[</span><span class="va">par_tab</span><span class="op">$</span><span class="va">names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>,<span class="st">"beta"</span><span class="op">)</span>,<span class="st">"values"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>In the simulation, we assumed that individuals could be exposed in
each of 50 years (i.e., an individual aged 50 or over could be infected
between 0 and 50 times). This is clearly many exposure states to impute,
and given we only have two biomarker measurements per individual, we
restrict the parameter space to be explored. Here, we estimate exposure
states in 5-year windows (i.e., was an individual infected in this
5-year period?) for historic times, and in 1-year windows for the final
5 years of the simulation. The vector <code>exposure_times</code>
demarcates the lower bound of each of these time windows. We consider
the â€œtrueâ€ exposure state to be whether or not an individual was exposed
at least once in each of these time windows.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Setup some inputs for serosolver -- this just tells the function the vector of possible</span></span>
<span><span class="co">## exposure times. The antigenic map is uninformative here, but is used in other examples</span></span>
<span><span class="co">## to capture cross-reactivity</span></span>
<span><span class="co">#exposure_times &lt;- seq(1,max(sero_data$samples),by=1) # If we wanted to estimated exposure states for each of 50 years</span></span>
<span><span class="va">exposure_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">45</span>,by<span class="op">=</span><span class="fl">5</span><span class="op">)</span>, <span class="fl">46</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">true_inf_hist</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">exposure_histories_long</span></span>
<span><span class="va">true_inf_hist</span><span class="op">$</span><span class="va">t_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">true_inf_hist</span><span class="op">$</span><span class="va">t</span>, breaks<span class="op">=</span><span class="va">exposure_times</span><span class="op">)</span> <span class="co"># Note which time block each exposure time is in</span></span>
<span></span>
<span><span class="co">## THis is a data structure used by serosolver for antigenically variable pathogens -- it can be largely ignored here</span></span>
<span><span class="va">antigenic_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"x_coord"</span><span class="op">=</span><span class="fl">1</span>,<span class="st">"y_coord"</span><span class="op">=</span><span class="fl">1</span>,<span class="st">"inf_times"</span><span class="op">=</span><span class="va">exposure_times</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Total number of exposures</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">true_inf_hist</span><span class="op">$</span><span class="va">value</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 567</span></span>
<span></span>
<span><span class="va">true_inf_hist</span> <span class="op">&lt;-</span> <span class="fu">convert_inf_hist_to_serosolver</span><span class="op">(</span><span class="va">true_inf_hist</span>,<span class="va">exposure_times</span><span class="op">)</span> <span class="co"># Convert the true exposure history to the format expected by serosolver</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'i'. You can override using the `.groups`</span></span>
<span><span class="co">#&gt; argument.</span></span>
<span><span class="co">#&gt; Using x as value column: use value.var to override.</span></span></code></pre></div>
<p>Part of fitting the <code>serosolver</code> model is to estimated the
antibody kinetics model parameters. Jointly estimated exposure states
and antibody kinetics is a challenging inference problem with potential
identifiability issues. We therefore place a strong prior on the waning
rate parameter to aid with identifiability.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior_func</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par_tab</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">dlnorm</a></span><span class="op">(</span><span class="va">pars</span><span class="op">[</span><span class="st">"wane"</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.008</span><span class="op">)</span>,<span class="fl">0.25</span>,log<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">pr</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-serosolver">4.2 Running <code>serosolver</code><a class="anchor" aria-label="anchor" href="#running-serosolver"></a>
</h3>
<p>We are now ready to run <code>serosolver</code> and fit the model to
our simulated data. The code below runs <code>n_chains</code> in
parallel using <code>foreach</code>. Within each iteration, we must
specify where in parameter space the MCMC chain starts â€“ the
<code>while</code> loop generates random initial parameter values and
exposure histories until it finds one which returns a finite likelihood,
and uses this as initial values for the MCMC.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Set up posterior function for later. Data_type=2 is for continuous data</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/create_posterior_func.html" class="external-link">create_posterior_func</a></span><span class="op">(</span><span class="va">par_tab</span>,<span class="va">sero_data</span>,version<span class="op">=</span><span class="fl">2</span>,data_type<span class="op">=</span><span class="fl">2</span>,antigenic_map<span class="op">=</span><span class="va">antigenic_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; Setting to continuous, bounded observations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Creating posterior solving function...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">## Time runs and use dopar to run multiple chains in parallel</span></span>
<span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">filenames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">chain_wd</span>, <span class="st">"/"</span>,<span class="va">run_name</span>, <span class="st">"_"</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="op">(</span>x <span class="op">=</span> <span class="va">filenames</span>, .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'data.table'</span>,<span class="st">'plyr'</span>,<span class="st">"dplyr"</span>,<span class="st">"serosolver"</span><span class="op">)</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span></span>
<span>    <span class="va">index</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="co">## Try generating random starting values until we find a set that returns a finite likelihood</span></span>
<span>    <span class="va">lik</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span>    <span class="va">inf_hist_correct</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="kw">while</span><span class="op">(</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">lik</span><span class="op">)</span> <span class="op">||</span> <span class="va">inf_hist_correct</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">index</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">start_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/generate_start_tab.html" class="external-link">generate_start_tab</a></span><span class="op">(</span><span class="va">par_tab</span><span class="op">)</span></span>
<span>        <span class="va">start_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/setup_infection_histories_total.html" class="external-link">setup_infection_histories_total</a></span><span class="op">(</span><span class="va">sero_data</span>,<span class="va">exposure_times</span>,<span class="fl">1</span>,<span class="fl">100</span><span class="op">)</span></span>
<span>        </span>
<span>        <span class="va">inf_hist_correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/check_inf_hist.html" class="external-link">check_inf_hist</a></span><span class="op">(</span><span class="va">sero_data</span>, <span class="va">exposure_times</span>, <span class="va">start_inf</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">f</span><span class="op">(</span><span class="va">start_tab</span><span class="op">$</span><span class="va">values</span>, <span class="va">start_inf</span><span class="op">)</span></span>
<span>        <span class="va">lik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">index</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co">## Run serosolver!</span></span>
<span>    <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">serosolver</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/run_MCMC.html" class="external-link">run_MCMC</a></span><span class="op">(</span><span class="va">start_tab</span>, <span class="va">sero_data</span>,</span>
<span>                                strain_isolation_times <span class="op">=</span> <span class="va">exposure_times</span>,</span>
<span>                                start_inf_hist<span class="op">=</span><span class="va">start_inf</span>,</span>
<span>                                filename<span class="op">=</span><span class="va">x</span>,</span>
<span>                                antigenic_map<span class="op">=</span><span class="va">antigenic_map</span>,</span>
<span>                                CREATE_POSTERIOR_FUNC<span class="op">=</span><span class="va">create_posterior_func</span>, </span>
<span>                                CREATE_PRIOR_FUNC <span class="op">=</span> <span class="va">prior_func</span>,</span>
<span>                                version<span class="op">=</span><span class="fl">2</span>,</span>
<span>                                mcmc_pars<span class="op">=</span><span class="va">mcmc_pars</span>,</span>
<span>                                data_type<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting-the-serosolver-outputs-and-comparing-to-the-simulation-ground-truth">4.3 Plotting the <code>serosolver</code> outputs and comparing to
the simulation ground-truth<a class="anchor" aria-label="anchor" href="#plotting-the-serosolver-outputs-and-comparing-to-the-simulation-ground-truth"></a>
</h3>
<p>We now check that the MCMC chains have converged, and then compare
the <code>serosolver</code> estimates to the <code>serosim</code>
gorund-truth. We can see that the MCMC chains are well mixed and
converged, and that the upper 95% CI for the R-hat diagnostic is &lt;1.1
for all model parameters (if it isnâ€™t, we would ned to run the chains
for more iterations).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Read in the MCMC chains and create a trace plot</span></span>
<span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span><span class="va">chain_wd</span>,par_tab<span class="op">=</span><span class="va">par_tab</span>,convert_mcmc<span class="op">=</span><span class="cn">TRUE</span>,burnin <span class="op">=</span> <span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,unfixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Chains detected:     5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Highest MCMC sample interations:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1000001</span></span>
<span><span class="co">#&gt; 1000001</span></span>
<span><span class="co">#&gt; 1000001</span></span>
<span><span class="co">#&gt; 1000001</span></span>
<span><span class="co">#&gt; 1000001</span></span>
<span><span class="co">#&gt; Chains detected: </span></span>
<span><span class="co">#&gt; /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery/serosim_recovery_1_infection_histories.csv</span></span>
<span><span class="co">#&gt; /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery/serosim_recovery_2_infection_histories.csv</span></span>
<span><span class="co">#&gt; /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery/serosim_recovery_3_infection_histories.csv</span></span>
<span><span class="co">#&gt; /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery/serosim_recovery_4_infection_histories.csv</span></span>
<span><span class="co">#&gt; /Users/arthur/Documents/GitHub/serosim/vignettes/chains/serosim_recovery/serosim_recovery_5_infection_histories.csv</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Reading in infection history chains. May take a while.</span></span>
<span><span class="co">#&gt; Number of rows:</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 1454341</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 1411258</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 1398593</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] 1443899</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1] 1462049</span></span>
<span><span class="co">## Save traceplots from coda package</span></span>
<span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sampno</span>, <span class="va">chain_no</span>, <span class="va">mu_short</span>, <span class="va">wane</span>, <span class="va">error</span>,<span class="va">total_infections</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sampno</span>,<span class="va">chain_no</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>chain_no<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">chain_no</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sampno</span>,y<span class="op">=</span><span class="va">value</span>,col<span class="op">=</span><span class="va">chain_no</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>,scales<span class="op">=</span><span class="st">"free_y"</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Check Rhat statistic for antibody kinetics parameters</span></span>
<span><span class="va">list_chains</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">$</span><span class="va">theta_list_chains</span></span>
<span><span class="va">list_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">list_chains</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span>,<span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mu_short"</span>,<span class="st">"wane"</span>,<span class="st">"error"</span>,<span class="st">"total_infections"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">gelman.diag</span><span class="op">(</span><span class="fu">as.mcmc.list</span><span class="op">(</span><span class="va">list_chains</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; mu_short               1.01       1.03</span></span>
<span><span class="co">#&gt; wane                   1.02       1.03</span></span>
<span><span class="co">#&gt; error                  1.01       1.03</span></span>
<span><span class="co">#&gt; total_infections       1.02       1.04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Multivariate psrf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1.02</span></span>
<span><span class="fu">effectiveSize</span><span class="op">(</span><span class="fu">as.mcmc.list</span><span class="op">(</span><span class="va">list_chains</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         mu_short             wane            error total_infections </span></span>
<span><span class="co">#&gt;         633.8537         255.8345         653.9727         220.9138</span></span></code></pre></div>
<p>Next, we interrogate the estimates from <code>serosolver</code>. We
can see that the 95% credible intervals (CrI) on the estimated total
number of exposures captures the true value. It also looks like we are
slightly overestimating the boosting and waning rates, despite the
strong prior on the waning rate. This may not be too surprising: the
simulation model has substantial heterogeneity in the degree of antibody
boosting and waning, as well as sources of observation error not
captured in the <code>serosolver</code> model. The error in the
<code>serosolver</code> estimates are likely a reflection of failing to
account for these mechanisms. However, overall, the estimates are not
too far from truth.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Read in chains for all other plots</span></span>
<span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/load_mcmc_chains.html" class="external-link">load_mcmc_chains</a></span><span class="op">(</span><span class="va">chain_wd</span>,convert_mcmc<span class="op">=</span><span class="cn">FALSE</span>,burnin <span class="op">=</span> <span class="va">mcmc_pars</span><span class="op">[</span><span class="st">"adaptive_period"</span><span class="op">]</span>,unfixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">)</span></span>
<span><span class="va">inf_chain</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">$</span><span class="va">inf_chain</span> </span>
<span><span class="co">## Total number of infections</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"True number of exposures: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">true_inf_hist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "True number of exposures: 558"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Estimated median and 95% CrI on number of exposures: "</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">total_infections</span><span class="op">)</span>, <span class="st">" ("</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">total_infections</span>, <span class="fl">0.025</span><span class="op">)</span>, <span class="st">"-"</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">total_infections</span>, <span class="fl">0.975</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estimated median and 95% CrI on number of exposures: 565 (489-710)"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"True boosting mean: "</span>, <span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"boost"</span>, <span class="st">"mean"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "True boosting mean: 4"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Estimated boosting (posterior mean and 95% CrI): "</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">mu_short</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">" ("</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">mu_short</span>, <span class="fl">0.025</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">"-"</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">mu_short</span>, <span class="fl">0.975</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estimated boosting (posterior mean and 95% CrI): 4.52 (4.06-4.99)"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"True waning rate mean: "</span>, <span class="va">model_pars</span><span class="op">[</span><span class="va">model_pars</span><span class="op">$</span><span class="va">exposure_id</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">model_pars</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"wane"</span>, <span class="st">"mean"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "True waning rate mean: 0.008"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Estimated waning rate (posterior mean and 95% CrI): "</span>,  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">wane</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">" ("</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">wane</span>, <span class="fl">0.025</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">"-"</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">chains</span><span class="op">$</span><span class="va">theta_chain</span><span class="op">$</span><span class="va">wane</span>, <span class="fl">0.975</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estimated waning rate (posterior mean and 95% CrI): 0.0182 (0.0126-0.0241)"</span></span></code></pre></div>
<p>One of the estimates we are most concerned with are the individual
exposure histories. The following two plots show the estimated exposure
histories from <code>serosolver</code> for 25 individuals in two ways.
The first plot shows the cumulative number of exposures over time â€“ the
x-axis gives the time-period, and the plotted line moves up by one one
the y-axis when an exposure is imputed. The solid blue line shows the
true cumulative exposure history, whereas the coloured regions and lines
show the posterior 95% CrI and median estimated by
<code>serosolver</code>. Note that the different colours represent
estimates from the 5 different MCMC chains.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot individual infection history estimates</span></span>
<span><span class="va">p_cumu_infs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/generate_cumulative_inf_plots.html" class="external-link">generate_cumulative_inf_plots</a></span><span class="op">(</span><span class="va">inf_chain</span>,indivs<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span>,</span>
<span>                                             real_inf_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">true_inf_hist</span><span class="op">)</span>,</span>
<span>                                             strain_isolation_times <span class="op">=</span> <span class="va">exposure_times</span>,nsamp<span class="op">=</span><span class="fl">100</span>,</span>
<span>                                             number_col <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">p_cumu_infs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-24-1.png" width="672">
The second plot shows the posterior density that an individual was
infected in a given time period â€“ the x-axis is the same time-axis as
the previous plot, but now the y-axis is the posterior probabily of an
exposure in that time period. The vertical red lines show the timing of
true infections, and the coloured lines show the posterior probabilities
from each of the 5 MCMC chains.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_cumu_infs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>Overall, we see that although we largely estimated the correct total
number of exposures per person, the timings of these exposure events is
off in places. This is somewhat unsurprising â€“ we are trying to infer
the timing of events that happened many years before our measurements
were taken. Thus, the only information the model has to back-calculate
these infection events is the antibody waning rate.</p>
<p>We next compare the model-estimate attack rates for the two locations
(urban and rural) to the ground truth. The following plot shows the
posterior mean and 95% CrI on the proportion of the alive population
exposed in that each time period (red pointrange) compared to the ground
truth (purple points). The blue pointranges denote time periods in which
serum samples were taken. The left-hand plot corresponds to the urban
location, whereas the right-hand plot corresponds to the rural location.
We see substantial uncertainty in time periods further back in time,
reflecting the smaller number of alive individuals in those older time
periods. We can also roughly see the trend of decreasing incidence over
time in the urban population and higher recent incidence in the rural
population, however, the estimates are not particularly precise, and we
are substantially underestimating the attack rates in the 5-year windows
starting in year 31 and year 41. It seems likely that those exposures
are being incorrectly placed in the time window around year 36.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot attack rates</span></span>
<span><span class="co">## Get number alive in each time point and true number of exposures per time point</span></span>
<span><span class="va">inf_chain</span> <span class="op">&lt;-</span> <span class="va">inf_chain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i)`</span></span>
<span></span>
<span><span class="co">## Get number of individuals alive to be exposed in each time period by group</span></span>
<span><span class="va">n_alive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/get_n_alive_group.html" class="external-link">get_n_alive_group</a></span><span class="op">(</span><span class="va">sero_data</span>, <span class="va">exposure_times</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">true_inf_hist</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">exposure_times</span></span>
<span><span class="co">## Get true number of exposures from serosim output by time period</span></span>
<span><span class="va">n_inf</span> <span class="op">&lt;-</span> <span class="va">true_inf_hist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">demography</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>ar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(i)`</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'name'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span></span>
<span><span class="va">n_alive</span> <span class="op">&lt;-</span> <span class="va">n_alive</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create tibble of true per-time attack rates</span></span>
<span><span class="va">true_ar</span> <span class="op">&lt;-</span> <span class="va">n_inf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">n_alive</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>AR <span class="op">=</span> <span class="va">ar</span><span class="op">/</span><span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>j<span class="op">=</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(name, group)`</span></span>
<span></span>
<span><span class="co">## Group 2 is the rural location, group 1 is the urban location</span></span>
<span><span class="va">p_ar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/plot_attack_rates.html" class="external-link">plot_attack_rates</a></span><span class="op">(</span><span class="va">inf_chain</span>, <span class="va">sero_data</span>, <span class="va">exposure_times</span>,true_ar<span class="op">=</span><span class="va">true_ar</span>,by_group<span class="op">=</span><span class="cn">TRUE</span>,pad_chain<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will</span></span>
<span><span class="co">#&gt; replace the existing one.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">x</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span></span>
<span><span class="va">p_ar</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<p>Finally, we compare the model-estimated biomarker kinetics for each
individual to the observed data. Each subplot corresponds to one
individual, where the x-axis represents time and the y-axis represents
biomarker measurement. The black dots show the observed data, whereas
the green shaded region and solid line shows the posterior 95%
prediction intervals, 95% CrI and posterior mean. The vertical orange
bars show the posterior probability of an exposure event at that time
period. The model fits seem reasonable, but unsurprisingly, the latent
antibody levels going back in time demonstrate substantial uncertainty
as the timings of exposure are not estimated precisely.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot model fits to titre data. We expand the sero_data object so that the function plots</span></span>
<span><span class="co">## for all possible times, not just those with observation times.</span></span>
<span><span class="va">sero_data_tmp</span> <span class="op">&lt;-</span> <span class="fu">expand_sero_data</span><span class="op">(</span><span class="va">sero_data</span>, <span class="va">exposure_times</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(individual)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(individual, samples)`</span></span>
<span></span>
<span><span class="va">titre_pred_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/serosolver/man/plot_infection_histories.html" class="external-link">plot_infection_histories</a></span><span class="op">(</span>chain <span class="op">=</span> <span class="va">chain</span><span class="op">[</span><span class="va">chain</span><span class="op">$</span><span class="va">chain_no</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span>, </span>
<span>                         infection_histories <span class="op">=</span> <span class="va">inf_chain</span><span class="op">[</span><span class="va">inf_chain</span><span class="op">$</span><span class="va">chain_no</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span>, </span>
<span>                         titre_dat <span class="op">=</span> <span class="va">sero_data_tmp</span>, </span>
<span>                         individuals <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span>,</span>
<span>                         strain_isolation_times <span class="op">=</span> <span class="va">exposure_times</span>,</span>
<span>                         nsamp <span class="op">=</span> <span class="fl">100</span>, <span class="co"># Needs to be smaller than length of sampled chain </span></span>
<span>                         par_tab <span class="op">=</span> <span class="va">par_tab</span>,p_ncol<span class="op">=</span><span class="fl">5</span>, data_type<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Setting to continuous, bounded observations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Creating model solving function...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="va">titre_pred_p</span></span>
<span><span class="co">#&gt; Warning: Removed 180 rows containing missing values (`geom_point()`).</span></span></code></pre></div>
<p><img src="case_study_4_inference_files/figure-html/unnamed-chunk-27-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="summary-1">4.4 Summary<a class="anchor" aria-label="anchor" href="#summary-1"></a>
</h3>
<p>As in the <code>serofoi</code> section, there are many different ways
in which we could further our simulation-recovery experiments. We see
that <code>serosolver</code> is broadly able to re-estimate the
individual exposure histories, antibody kinetics model parameters (with
a strong prior on the waning rate), and population attack rates.
However, there were some biases and inaccuracies in our estimates,
highlighting the consequences of a fitted model which does not quite
match the generative model, and also limits of identifiability from
fitting a fairly complex model to a relatively small dataset. Some
suggestions for further experiments the reader might try are:</p>
<ol style="list-style-type: decimal">
<li>Fitting the <code>serosolver</code> model to the simulation
including vaccination (<code>res_vaccination</code>).</li>
<li>Adjusting the time windows of the inferred exposure histories to
understand the time resolution that can be reliably inferred from the
current serological study design.</li>
<li>Simulating larger serological studies with more and individuals
and/or more longitudinal samples per individual.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="conclusions">5.0 Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>In this vignette, we have seen how <code>serosim</code> can be used
to generate synthetic data for testing two inference packages:
<code>serofoi</code> and <code>serosolver</code>. Both inference
packages have functionality for simulating data from the fitted model â€“
a recommended test prior to fitting any statistical model to real data,
but arguably an easy test given that the fitted model is correctly
specified. Crucially, the <code>serosim</code> model included realistic,
complex processes which we expect to be important for generating our
data, but which are infeasible to include in our fitted models. Despite
this model misspecification/over-simplification, both packages generate
useful and reasonable estimates for the force of exposure, exposure
histories and antibody kinetics, but with some error and bias. We
suggest that this process of simulation-recovery using a simulation
model that is different to the fitted model is a useful approach for
understanding the performance of seroepidemiological inference methods
prior to fitting to real data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Arthur Menezes, James Hay.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
